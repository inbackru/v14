{% extends "base.html" %}

{% block title %}Кэшбек за новостройки в Краснодаре до 500 000 ₽ | inback{% endblock %}
{% block description %}Как получить кэшбек 2,5-10% за новостройку? Пошаговая инструкция работы сервиса Inback. Официальный возврат денег от застройщика при покупке квартиры в Краснодаре{% endblock %}
{% block keywords %}как получить кэшбек за квартиру, кэшбек за новостройку, возврат денег за квартиру, система кэшбека inback, оформление кэшбека, этапы получения кэшбека{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /* Mobile-specific styles */
    @media (max-width: 640px) {
        .property-card {
            margin-bottom: 12px;
        }
        .property-card .carousel {
            height: 160px;
        }
        .property-card .carousel-item img {
            height: 160px;
            object-fit: cover;
        }
        .property-card .carousel-controls {
            display: none;
        }
    }

    /* Compact dropdown menu */
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-btn {
        background: transparent;
        border: none;
        color: #141A24;
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .dropdown-btn:hover {
        background: rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-btn svg {
        width: 16px;
        height: 16px;
        transition: transform 0.2s;
    }
    
    .dropdown-btn.open svg {
        transform: rotate(180deg);
    }
    
    .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 0.5rem 0;
        min-width: 200px;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .dropdown-menu .dropdown-section {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .dropdown-menu .dropdown-section:last-child {
        border-bottom: none;
    }
    
    .dropdown-menu .dropdown-section h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    
    .dropdown-menu .filter-option {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .dropdown-menu .filter-option:hover {
        color: #0088CC;
    }
    
    .dropdown-menu .filter-option input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        accent-color: #0088CC;
    }
    
    .dropdown-menu .price-inputs {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
    }
    
    .dropdown-menu .price-inputs input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        outline: none;
    }
    
    .dropdown-menu .price-inputs input:focus {
        border-color: #0088CC;
        box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-menu .apply-price-btn {
        background: #0088CC;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        margin: 0.5rem 1rem 0;
        transition: opacity 0.2s;
    }
    
    .dropdown-menu .apply-price-btn:hover {
        opacity: 0.9;
    }
    
    /* Active filter chips */
    .active-filter-chip {
        display: inline-flex;
        align-items: center;
        background: #0088CC;
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        gap: 0.5rem;
        margin: 0.25rem;
    }
    
    .active-filter-chip .remove-btn {
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: background 0.2s;
    }
    
    .active-filter-chip .remove-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* Beautiful Filter Button Styles */
    .filter-option-btn {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        position: relative;
    }

    .filter-option-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn.active {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #1d4ed8;
    }

    .filter-option-btn.active svg {
        color: #3b82f6;
    }

    /* Quick Filter Dropdown Styles */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 200px;
        padding: 0.5rem;
        margin-top: 0.25rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }

    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.15s;
        font-size: 0.875rem;
    }

    .dropdown-item:hover {
        background-color: #f3f4f6;
    }

    /* Filter counter badge */
    .filter-counter {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
    }
    
    /* Toggle switches */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #0088CC;
        background-color: #0088CC;
    }
    
    .toggle-checkbox:checked + .toggle-label {
        background-color: #0088CC;
    }
    
    .toggle-label {
        transition: background-color 0.2s;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs -->
<div class="container mx-auto px-4 py-3 text-sm">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('index') }}" class="text-[#0088CC] hover:underline inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    Главная
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="text-gray-500 ml-1 md:ml-2">Поиск объектов</span>
                </div>
            </li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Advanced Search Form -->
<section id="properties" class="py-20 bg-white">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center mb-6">10 000+ квартир в базе</h2>
        <p class="text-xl text-gray-600 text-center mb-12">Подберите идеальную квартиру в Краснодаре с максимальным кэшбэком</p>
    </div>
</section>

<!-- Search Block -->
<section class="py-8 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Enhanced Smart Search Bar -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 mb-4">
            <!-- Search Input Row -->
            <div class="flex flex-col lg:flex-row gap-3 items-center">
                <!-- Enhanced Search Input -->
                <div class="flex-1 relative">
                    <input type="text" 
                           id="property-search"
                           placeholder="Умный поиск: район, застройщик, ЖК, тип квартиры..." 
                           class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-gray-700">
                    <!-- Enhanced Search Suggestions -->
                    <div id="property-searchSuggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md mt-1 shadow-lg z-50 max-h-96 overflow-y-auto">
                        <!-- Suggestions will be populated by JavaScript -->
                    </div>
                </div>
                <!-- Search Results Info -->
                <div class="text-sm text-gray-500">
                    Поиск с подсказками
                </div>
            </div>
        </div>

        <!-- Quick Filters -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3">
            <div class="flex items-center gap-3 text-sm">
                <div class="text-gray-600 whitespace-nowrap font-medium">Быстрые фильтры</div>
                
                <!-- Quick Filter Buttons -->
                <div class="flex flex-wrap gap-2">
                    <!-- Room Type Filter -->
                    <div class="dropdown" data-filter="rooms">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="roomsFilterText">Комнат</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="студия" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> Студия
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="1-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 1-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 2-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="3-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 3-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="4+-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 4-комнатная
                            </label>
                        </div>
                    </div>
                    
                    <!-- Price Filter -->
                    <div class="dropdown" data-filter="price">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="priceFilterText">Цена</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu" style="min-width: 280px;">
                            <div class="p-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">От, млн ₽</label>
                                        <input type="number" id="priceFrom" placeholder="1" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">До, млн ₽</label>
                                        <input type="number" id="priceTo" placeholder="20" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                                <button onclick="applyPriceFilter()" class="w-full bg-[#0088CC] text-white py-2 rounded mt-3 text-sm hover:opacity-90">Применить</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- District Filter -->
                    <div class="dropdown" data-filter="districts">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="districtFilterText">Район</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="Центральный" data-filter-type="district" class="mr-2"> Центральный
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Западный" data-filter-type="district" class="mr-2"> Западный
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Карасунский" data-filter-type="district" class="mr-2"> Карасунский
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Прикубанский" data-filter-type="district" class="mr-2"> Прикубанский
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Фестивальный" data-filter-type="district" class="mr-2"> Фестивальный
                            </label>
                        </div>
                    </div>
                    
                    <!-- Developer Filter -->
                    <div class="dropdown" data-filter="developers">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="developerFilterText">Застройщик</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="КГС" data-filter-type="developer" class="mr-2"> КГС
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="ЮИТ" data-filter-type="developer" class="mr-2"> ЮИТ
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Галактика" data-filter-type="developer" class="mr-2"> Галактика
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Олимп" data-filter-type="developer" class="mr-2"> Олимп
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="СК-Строй" data-filter-type="developer" class="mr-2"> СК-Строй
                            </label>
                        </div>
                    </div>
                    
                    <!-- Completion Date Filter -->
                    <div class="dropdown" data-filter="completion">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="completionFilterText">Сдача</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="Сдан" data-filter-type="completion" class="mr-2"> Сдан
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2024" data-filter-type="completion" class="mr-2"> 2024
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2025" data-filter-type="completion" class="mr-2"> 2025
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2026" data-filter-type="completion" class="mr-2"> 2026
                            </label>
                        </div>
                    </div>
                    
                    <!-- All Filters Button -->
                    <button id="toggleAllFilters" class="flex items-center gap-1 border border-gray-300 px-3 py-1.5 rounded hover:bg-gray-50 transition-all relative text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                        </svg>
                        <span>Еще</span>
                        <div id="allFiltersCounter" class="hidden absolute -top-1 -right-1 bg-[#0088CC] text-white text-xs font-bold rounded-full w-4 h-4 flex items-center justify-center">0</div>
                    </button>
                    
                    <!-- Search Button -->
                    <button id="applyFiltersBtn" onclick="applyFiltersFixed()" class="px-4 py-1.5 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white font-medium rounded hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-sm hover:shadow-md whitespace-nowrap text-sm">
                        <i class="fas fa-search mr-1"></i>
                        Найти
                    </button>

                    <!-- Save Search Button -->
                    <div class="relative">
                        <button id="saveSearchBtn" onclick="toggleSaveSearchDropdown()" class="px-3 py-1.5 border border-[#0088CC] text-[#0088CC] rounded hover:bg-[#0088CC] hover:text-white transition-all duration-300 whitespace-nowrap text-sm" title="Сохранить поиск">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        
                        <!-- Save Search Dropdown -->
                        <div id="saveSearchDropdown" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-72">
                            <div class="p-3">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Название поиска</label>
                                    <input type="text" id="searchNameInput" placeholder="Название поиска" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-[#0088CC] focus:border-[#0088CC]">
                                </div>
                                
                                {% if current_user.is_authenticated and current_user.role == 'manager' %}
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email клиента (опционально)</label>
                                    <input type="email" id="clientEmailInput" placeholder="client@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-[#0088CC] focus:border-[#0088CC]">
                                    <p class="text-xs text-gray-500 mt-1">Если указан, поиск будет отправлен клиенту</p>
                                </div>
                                {% endif %}
                                
                                <div class="flex gap-2">
                                    <button onclick="saveSearchWithOptions()" class="flex-1 px-3 py-2 bg-[#0088CC] text-white rounded-md text-sm hover:bg-[#0077BB] transition">
                                        Сохранить
                                    </button>
                                    <button onclick="closeSaveSearchDropdown()" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 transition">
                                        Отмена
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Counter -->
                    <div class="text-gray-600 px-3 py-1.5 whitespace-nowrap text-sm">
                        <span id="resultsCounter" class="font-medium">{{ pagination.total }} объектов</span>
                    </div>
                </div>
                

            </div>
            
            <!-- Active Filters Display -->
            <div id="activeFiltersContainer" class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-sm text-gray-600">Активные фильтры:</span>
                    <div id="activeFiltersList" class="flex flex-wrap gap-2">
                        <!-- Active filters will be shown here -->
                    </div>
                    <button id="clearAllFiltersBtn" onclick="clearAllActiveFilters()" class="text-[#0088CC] hover:underline text-sm ml-2 hidden">
                        Сбросить все
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Advanced Filters Panel -->
        <div id="allFiltersPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Location Section -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-800 border-b border-gray-200 pb-2">Расположение</h3>
                    
                    <!-- Region -->
                    <div>
                        <label class="flex items-center text-sm text-gray-700 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            </svg>
                            Регион
                            <span class="ml-auto bg-gray-100 text-green-800 text-xs px-2 py-1 rounded">New</span>
                        </label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-white">
                            <option>Краснодарский край</option>
                        </select>
                    </div>
                    
                    <!-- Distance to center -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        </svg>
                        До центра
                    </label>
                    
                    <!-- Registration -->
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded border border-gray-200">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Прописка
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="registration" value="Возможна" onchange="updateAdvancedFilters()"> Возможна
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="registration" value="Невозможна" onchange="updateAdvancedFilters()"> Невозможна
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="registration" value="Временная" onchange="updateAdvancedFilters()"> Временная
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Near places -->
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded border border-gray-200">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Места рядом (2 км)
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Школа" onchange="updateAdvancedFilters()"> Школа
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Детский сад" onchange="updateAdvancedFilters()"> Детский сад
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Больница" onchange="updateAdvancedFilters()"> Больница
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Супермаркет" onchange="updateAdvancedFilters()"> Супермаркет
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Транспорт" onchange="updateAdvancedFilters()"> Транспорт
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Парк" onchange="updateAdvancedFilters()"> Парк
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Window view -->
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded border border-gray-200">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Вид из окон
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На двор" onchange="updateAdvancedFilters()"> На двор
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На улицу" onchange="updateAdvancedFilters()"> На улицу
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На море" onchange="updateAdvancedFilters()"> На море
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На горы" onchange="updateAdvancedFilters()"> На горы
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Special apartments -->
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded border border-gray-200">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                                Видовые квартиры
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="Угловая" onchange="updateAdvancedFilters()"> Угловая
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="Пентхаус" onchange="updateAdvancedFilters()"> Пентхаус
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="Двухуровневая" onchange="updateAdvancedFilters()"> Двухуровневая
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="С террасой" onchange="updateAdvancedFilters()"> С террасой
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sides of the world -->
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded border border-gray-200">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                Стороны света
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Север" onchange="updateAdvancedFilters()"> Север
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Юг" onchange="updateAdvancedFilters()"> Юг
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Восток" onchange="updateAdvancedFilters()"> Восток
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Запад" onchange="updateAdvancedFilters()"> Запад
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- House Section -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-800 border-b border-gray-200 pb-2">Дом</h3>
                    
                    <!-- Property type -->
                    <div>
                        <label class="flex items-center text-sm text-gray-700 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            Тип недвижимости • 4
                        </label>
                        <div class="space-y-2">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" data-filter-type="propertyType" value="Квартира" class="mr-2 text-[#0088CC]"> Квартира
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" data-filter-type="propertyType" value="Апартаменты" class="mr-2 text-[#0088CC]"> Апартаменты
                            </label>
                        </div>
                    </div>
                    
                    <!-- Property class -->
                    <div class="filter-dropdown">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Класс недвижимости
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Эконом" onchange="updateAdvancedFilters()"> Эконом
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Комфорт" onchange="updateAdvancedFilters()"> Комфорт
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Бизнес" onchange="updateAdvancedFilters()"> Бизнес
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Премиум" onchange="updateAdvancedFilters()"> Премиум
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Wall material -->
                    <div class="filter-dropdown">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Материал стен
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Кирпич" onchange="updateAdvancedFilters()"> Кирпич
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Монолит" onchange="updateAdvancedFilters()"> Монолит
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Панель" onchange="updateAdvancedFilters()"> Панель
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Газобетон" onchange="updateAdvancedFilters()"> Газобетон
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Floors in house -->
                    <div class="filter-dropdown">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Этажей в доме
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="до 5 этажей" onchange="updateAdvancedFilters()"> до 5 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="6-10 этажей" onchange="updateAdvancedFilters()"> 6-10 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="11-20 этажей" onchange="updateAdvancedFilters()"> 11-20 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="более 20 этажей" onchange="updateAdvancedFilters()"> более 20 этажей
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Apartments -->
                    <div class="filter-dropdown">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v0" />
                                </svg>
                                Тип собственности
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_type" value="Квартира" onchange="updateAdvancedFilters()"> Квартира
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_type" value="Апартаменты" onchange="updateAdvancedFilters()"> Апартаменты
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sales start -->
                    <div class="filter-dropdown">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 8v6m6-6v6" />
                                </svg>
                                Старт продаж
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="sales_start" value="Уже продается" onchange="updateAdvancedFilters()"> Уже продается
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="sales_start" value="1 кв. 2025" onchange="updateAdvancedFilters()"> 1 кв. 2025
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="sales_start" value="2 кв. 2025" onchange="updateAdvancedFilters()"> 2 кв. 2025
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="sales_start" value="3 кв. 2025" onchange="updateAdvancedFilters()"> 3 кв. 2025
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parking -->
                    <div class="filter-dropdown">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Паркинг
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="parking" value="Наземный" onchange="updateAdvancedFilters()"> Наземный
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="parking" value="Подземный" onchange="updateAdvancedFilters()"> Подземный
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="parking" value="Многоуровневый" onchange="updateAdvancedFilters()"> Многоуровневый
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="parking" value="Отсутствует" onchange="updateAdvancedFilters()"> Отсутствует
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Elevator -->
                    <div class="filter-dropdown">
                        <button class="dropdown-btn w-full flex items-center justify-between text-sm text-gray-700 hover:bg-gray-50 p-2 rounded">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                </svg>
                                Лифт
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="elevator" value="Пассажирский" onchange="updateAdvancedFilters()"> Пассажирский
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="elevator" value="Грузовой" onchange="updateAdvancedFilters()"> Грузовой
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="elevator" value="Отсутствует" onchange="updateAdvancedFilters()"> Отсутствует
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Apartment Section -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-800 border-b border-gray-200 pb-2">Квартира</h3>
                    
                    <!-- Floor -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Этаж
                    </label>
                    
                    <!-- Finishing -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z" />
                        </svg>
                        Отделка
                    </label>
                    
                    <!-- S privedennaya -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m10 0h4a1 1 0 011 1v4m0 10v4a1 1 0 01-1 1h-4m-10 0H4a1 1 0 01-1-1v-4" />
                        </svg>
                        S приведенная
                    </label>
                    
                    <!-- S kitchen -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m10 0h4a1 1 0 011 1v4m0 10v4a1 1 0 01-1 1h-4m-10 0H4a1 1 0 01-1-1v-4" />
                        </svg>
                        S кухни
                    </label>
                    
                    <!-- S balcony -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m10 0h4a1 1 0 011 1v4m0 10v4a1 1 0 01-1 1h-4m-10 0H4a1 1 0 01-1-1v-4" />
                        </svg>
                        S балкона
                    </label>
                    
                    <!-- S sanuzel -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 8v6m6-6v6" />
                        </svg>
                        Санузел
                    </label>
                    
                    <!-- Ceiling height -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m10 0h4a1 1 0 011 1v4m0 10v4a1 1 0 01-1 1h-4m-10 0H4a1 1 0 01-1-1v-4" />
                        </svg>
                        Высота потолков
                    </label>
                    
                    <!-- Balcony type -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m10 0h4a1 1 0 011 1v4m0 10v4a1 1 0 01-1 1h-4m-10 0H4a1 1 0 01-1-1v-4" />
                        </svg>
                        Тип балкона
                    </label>
                    
                    <!-- Windows -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Окна
                    </label>
                </div>
                
                <!-- Payment Section -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-800 border-b border-gray-200 pb-2">Оплата и документы</h3>
                    
                    <!-- Payment methods -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                        Способы оплаты
                    </label>
                    
                    <!-- PV from developer -->
                    <div class="flex items-center justify-between text-sm text-gray-700">
                        <label class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            ПВ от застройщика
                        </label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="pvToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="pvToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    
                    <!-- Mortgage types -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                        </svg>
                        Виды ипотеки
                    </label>
                    
                    <!-- Banks -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Банки
                    </label>
                    
                    <!-- Contract -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Договор
                    </label>
                    
                    <!-- Escrow -->
                    <div class="flex items-center justify-between text-sm text-gray-700">
                        <label class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Эскроу
                            <span class="ml-auto bg-gray-100 text-green-800 text-xs px-2 py-1 rounded">New</span>
                        </label>
                    </div>
                    
                    <!-- Investment growth -->
                    <label class="flex items-center text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        Инвестиционный рост цены
                    </label>
                    
                    <!-- Show foreclosure -->
                    <div class="flex items-center justify-between text-sm text-gray-700">
                        <span>Показать 1 295 брошен</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="foreclosureToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="foreclosureToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Actions -->
            <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                <div class="flex gap-3">
                    <button onclick="clearAllAdvancedFilters()" class="text-gray-600 hover:text-gray-800 text-sm">Сбросить всё</button>
                    <button onclick="toggleAdvancedFilters()" class="text-[#0088CC] hover:underline text-sm">Свернуть</button>
                </div>
                
                <button onclick="applyAdvancedFilters()" class="bg-[#0088CC] text-white px-8 py-3 rounded-lg hover:opacity-90 font-medium flex items-center gap-2">
                    <span id="advancedResultsCount">195 квартир найдено</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</section>


<!-- Advanced Filters Section -->
<section id="advancedFiltersSection" class="py-6 bg-gray-50 hidden">
    <div class="container mx-auto px-4">
        <!-- Beautiful Filter Categories (Based on Screenshot) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <!-- Action Buttons -->
            <div class="flex justify-between items-center mb-6">
                <button id="clearAllFilters" class="text-gray-600 hover:text-gray-800 text-sm">
                    Сбросить всё
                </button>
                <button onclick="toggleAdvancedFilters()" class="text-gray-600 hover:text-gray-800 text-sm">
                    Свернуть
                </button>
            </div>
            
            <!-- Filter Categories -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                
                <!-- Расположение Column -->
                <div class="space-y-3">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Расположение</h3>
                    
                    <!-- Property Class Filter -->
                    <div class="relative filter-dropdown" data-filter="property_class">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Класс недвижимости</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Эконом"> Эконом
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Комфорт"> Комфорт
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Бизнес"> Бизнес
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="property_class" value="Премиум"> Премиум
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Wall Material Filter -->
                    <div class="relative filter-dropdown" data-filter="wall_material">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Материал стен</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Кирпич"> Кирпич
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Монолит"> Монолит
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Панель"> Панель
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="wall_material" value="Газобетон"> Газобетон
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Floors in House Filter -->
                    <div class="relative filter-dropdown" data-filter="floors_total">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Этажей в доме</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="до 5 этажей"> до 5 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="6-10 этажей"> 6-10 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="11-20 этажей"> 11-20 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="floors_total" value="более 20 этажей"> более 20 этажей
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="distance">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="text-gray-700">До центра</span>
                        </div>
                    </button>
                    
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span class="text-gray-700">Прописка</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="registration" value="Возможна" onchange="updateAdvancedFilters()"> Возможна
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="registration" value="Невозможна" onchange="updateAdvancedFilters()"> Невозможна
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="registration" value="Временная" onchange="updateAdvancedFilters()"> Временная
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                </svg>
                                <span class="text-gray-700">Места рядом (2 км)</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Школа" onchange="updateAdvancedFilters()"> Школа
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Детский сад" onchange="updateAdvancedFilters()"> Детский сад
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Больница" onchange="updateAdvancedFilters()"> Больница
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Супермаркет" onchange="updateAdvancedFilters()"> Супермаркет
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Транспорт" onchange="updateAdvancedFilters()"> Транспорт
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="nearby_places" value="Парк" onchange="updateAdvancedFilters()"> Парк
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="text-gray-700">Вид из окон</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На двор" onchange="updateAdvancedFilters()"> На двор
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На улицу" onchange="updateAdvancedFilters()"> На улицу
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На море" onchange="updateAdvancedFilters()"> На море
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="window_view" value="На горы" onchange="updateAdvancedFilters()"> На горы
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Видовые квартиры</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="Угловая" onchange="updateAdvancedFilters()"> Угловая
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="Пентхаус" onchange="updateAdvancedFilters()"> Пентхаус
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="Двухуровневая" onchange="updateAdvancedFilters()"> Двухуровневая
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="special_apartments" value="С террасой" onchange="updateAdvancedFilters()"> С террасой
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-dropdown relative">
                        <button class="dropdown-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                <span class="text-gray-700">Стороны света</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Север" onchange="updateAdvancedFilters()"> Север
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Юг" onchange="updateAdvancedFilters()"> Юг
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Восток" onchange="updateAdvancedFilters()"> Восток
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="world_sides" value="Запад" onchange="updateAdvancedFilters()"> Запад
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Дом Column -->
                <div class="space-y-3">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Дом</h3>
                    
                    <div class="relative filter-dropdown" data-filter="type">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Тип недвижимости • 4</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="propertyType" value="Квартира"> Квартира
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="propertyType" value="Дом"> Дом
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="propertyType" value="Пентхаус"> Пентхаус
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="propertyType" value="Коттедж"> Коттедж
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="propertyType" value="Таунхаус"> Таунхаус
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative filter-dropdown" data-filter="class">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Класс недвижимости</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="filter-dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="comfort" class="mr-2 text-[#0088CC]"> Комфорт
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="business" class="mr-2 text-[#0088CC]"> Бизнес
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="premium" class="mr-2 text-[#0088CC]"> Премиум
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="elite" class="mr-2 text-[#0088CC]"> Элитный
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative filter-dropdown" data-filter="material">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Материал стен</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="filter-dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="brick" class="mr-2 text-[#0088CC]"> Кирпич
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="monolith" class="mr-2 text-[#0088CC]"> Монолит
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="panel" class="mr-2 text-[#0088CC]"> Панель
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="block" class="mr-2 text-[#0088CC]"> Блоки
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative filter-dropdown" data-filter="floors">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="text-gray-700">Этажей в доме</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="filter-dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="1-5" class="mr-2 text-[#0088CC]"> 1-5 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="6-10" class="mr-2 text-[#0088CC]"> 6-10 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="11-17" class="mr-2 text-[#0088CC]"> 11-17 этажей
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" data-filter-value="18+" class="mr-2 text-[#0088CC]"> 18+ этажей
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="view">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="text-gray-700">Вид из окна</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="apartments">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                            <span class="text-gray-700">Апартаменты</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="sell-start">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                            <span class="text-gray-700">Старт продаж</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="keys">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                            </svg>
                            <span class="text-gray-700">Ключи</span>
                        </div>
                    </button>
                </div>

                <!-- Квартира Column -->
                <div class="space-y-3">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Квартира</h3>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="floor">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                            <span class="text-gray-700">Этаж</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="finishing">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                            <span class="text-gray-700">Отделка</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="s-suite">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m-6 9v8a1 1 0 001 1h4m-6-9a8 8 0 0116 0M9 5a2 2 0 012-2h2a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V5z"/>
                            </svg>
                            <span class="text-gray-700">S приведенная</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="s-kitchen">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m-6 9v8a1 1 0 001 1h4m-6-9a8 8 0 0116 0M9 5a2 2 0 012-2h2a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V5z"/>
                            </svg>
                            <span class="text-gray-700">S кухни</span>
                        </div>
                    </button>
                </div>

                <!-- Оплата и документы Column -->
                <div class="space-y-3">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Оплата и документы</h3>
                    
                    <!-- Payment Methods Filter -->
                    <div class="relative filter-dropdown" data-filter="payment">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                </svg>
                                <span class="text-gray-700">Способы оплаты</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="payment" value="ипотека"> Ипотека
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="payment" value="рассрочка"> Рассрочка от застройщика
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="payment" value="готовые"> Только готовые
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="payment" value="материнский-капитал"> Материнский капитал
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="payment" value="военная-ипотека"> Военная ипотека
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="payment" value="семейная-ипотека"> Семейная ипотека
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="developer-pv">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="text-gray-700">ПВ от застройщика</span>
                        </div>
                        <div class="relative">
                            <input type="checkbox" class="w-5 h-5 rounded border-gray-300 text-[#0088CC] focus:ring-[#0088CC]"/>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="mortgage-types">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                            </svg>
                            <span class="text-gray-700">Виды ипотеки</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="escrow">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                            </svg>
                            <span class="text-gray-700">Эскроу</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-gray-100 text-green-800 text-xs rounded-full font-medium">New</span>
                        </div>
                    </button>
                    
                    <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors" data-filter="show-reserved">
                        <div class="flex items-center gap-3">
                            <span class="text-gray-700">Показать 1 295 броней</span>
                        </div>
                        <div class="relative">
                            <input type="checkbox" class="w-5 h-5 rounded border-gray-300 text-[#0088CC] focus:ring-[#0088CC]"/>
                        </div>
                    </button>
                    
                    <!-- Distance to Center Filter -->
                    <div class="relative filter-dropdown" data-filter="distance">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="text-gray-700">До центра</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="distance" value="0-5"> До 5 км
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="distance" value="5-10"> 5-10 км
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="distance" value="10-15"> 10-15 км
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="distance" value="15+"> Более 15 км
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Area Filter -->
                    <div class="relative filter-dropdown" data-filter="area">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
                                </svg>
                                <span class="text-gray-700">Площадь</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3">
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">От, м²</label>
                                        <input type="number" id="areaFrom" placeholder="30" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-[#0088CC] focus:border-[#0088CC]" min="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">До, м²</label>
                                        <input type="number" id="areaTo" placeholder="200" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-[#0088CC] focus:border-[#0088CC]" min="0">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="area" value="30-50"> 30-50 м²
                                    </label>
                                    <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="area" value="50-70"> 50-70 м²
                                    </label>
                                    <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="area" value="70-100"> 70-100 м²
                                    </label>
                                    <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="area" value="100+"> Более 100 м²
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cardinal Directions Filter -->
                    <div class="relative filter-dropdown" data-filter="direction">
                        <button class="filter-option-btn w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m2-10v8a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8a2 2 0 012 2z"/>
                                </svg>
                                <span class="text-gray-700">Сторона света</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 dropdown-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="север"> Север
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="юг"> Юг
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="восток"> Восток
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="запад"> Запад
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="юго-восток"> Юго-Восток
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="юго-запад"> Юго-Запад
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="северо-восток"> Северо-Восток
                                </label>
                                <label class="flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="direction" value="северо-запад"> Северо-Запад
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Action Button -->
            <div class="mt-8 flex justify-end">
                <button class="bg-[#0088CC] hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-medium text-lg">
                    70 207 квартир в 244 ЖК
                </button>
        </div>
    </div>
</section>

<!-- Main Content Section -->
<section class="container mx-auto px-4 py-6">
    <div class="w-full mx-auto">
        <!-- Results Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">
                    Найдено <span id="results-count">{{ pagination.total }}</span> объектов
                </h3>
                <div class="flex gap-2">
                    <select id="sort-select" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="sortProperties()">
                        <option value="price-desc">По цене ↓</option>
                        <option value="price-asc">По цене ↑</option>
                        <option value="area-desc">По площади ↓</option>
                        <option value="area-asc">По площади ↑</option>
                        <option value="date-desc">По дате</option>
                    </select>
                    
                    <!-- View Toggle -->
                    <div class="flex items-center bg-gray-100 rounded-lg p-1">
                        <button onclick="switchToListView()" data-view="list" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                            </svg>
                            Список
                        </button>
                        <button onclick="switchToGridView()" data-view="grid" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            Сетка
                        </button>
                    </div>
                    
                    <a href="{{ url_for('map_view') }}" class="text-[#0088CC] hover:text-[#0077BB] flex items-center px-3 py-2 border border-[#0088CC] rounded-lg text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        Поиск по карте
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Properties Cards Section -->
<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <div class="bg-gray-50 rounded-xl shadow-md border border-gray-200 p-6">

                <!-- Property Cards -->
                <div id="properties-container" class="space-y-6">
                    {% for property in properties %}
                    <!-- Property Card (Original Design) -->
                    <div class="property-card bg-white rounded-lg shadow-sm overflow-hidden w-full flex flex-col md:flex-row" 
                         data-type="{{ property.type }}" 
                         data-rooms="{{ property.rooms }}" 
                         data-price="{{ property.price }}" 
                         data-district="{{ property.district }}" 
                         data-developer="{{ property.developer }}"
                         data-complex="{{ property.residential_complex or 'Не указан' }}"
                         data-property-type="{{ property.property_type or property.type }}"
                         data-completion="{{ property.completion_date or '2024' }}"
                         data-area="{{ property.area }}"
                         data-floor="{{ property.floor }}"
                         data-mortgage="{{ property.mortgage_available|default('true') }}"
                         data-installment="{{ property.installment_available|default('false') }}"
                         data-maternal-capital="{{ property.maternal_capital|default('false') }}"
                         data-trade-in="{{ property.trade_in|default('false') }}"
                         data-cashback="{{ property.cashback_available|default('true') }}">
                        <!-- Image Carousel - WIDER -->
                        <div class="w-full md:w-96 h-64 relative group flex-shrink-0">
                            <div class="carousel-container w-full h-full relative overflow-hidden rounded-lg bg-gray-100" data-property-id="{{ property.id }}">
                                <!-- Image slides -->
                                {% if property.gallery and property.gallery|length > 0 %}

                                    {% for image in property.gallery[:4] %}
                                    <div class="carousel-slide absolute inset-0 {% if loop.index0 > 0 %}opacity-0{% endif %} transition-opacity duration-300" data-slide="{{ loop.index0 }}">
                                        <img src="{{ image }}" 
                                             alt="{% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комн{% endif %} {{ property.area }} м² - фото {{ loop.index }}" 
                                             class="w-full h-full object-cover bg-gray-200" 
                                             loading="lazy"
                                             onerror="console.warn('Image load failed:', this.src); this.style.display='block'; this.style.backgroundColor='#f3f4f6'; this.innerHTML='<div class=\'flex items-center justify-center h-full text-gray-500\'>Фото недоступно</div>';">
                                    </div>
                                    {% endfor %}
                                {% else %}

                                    <div class="carousel-slide absolute inset-0 transition-opacity duration-300" data-slide="0">
                                        <img src="{{ property.image or 'https://via.placeholder.com/400x300/f3f4f6/9ca3af?text=Фото+недоступно' }}" 
                                             alt="{% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комн{% endif %} {{ property.area }} м²" 
                                             class="w-full h-full object-cover bg-gray-200" 
                                             loading="lazy"
                                             onerror="console.warn('Main image load failed:', this.src); this.style.backgroundColor='#f3f4f6';">
                                    </div>
                                {% endif %}
                                
                                <!-- Navigation arrows -->
                                <button onclick="prevImageSlide(this)" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                    </svg>
                                </button>
                                <button onclick="nextImageSlide(this)" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </button>
                                
                                <!-- Dots indicator -->
                                <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    {% set gallery_length = property.gallery|length if property.gallery else 1 %}
                                    {% set max_slides = [gallery_length, 4]|min %}
                                    {% for i in range(max_slides) %}
                                    <button onclick="goToImageSlide(this, {{ i }});" class="w-2.5 h-2.5 rounded-full {% if i == 0 %}bg-white/80{% else %}bg-white/50{% endif %} hover:bg-white transition-colors"></button>
                                    {% endfor %}
                                </div>
                            </div>
                            <!-- Overlay elements -->
                            <div class="absolute top-3 right-3 z-20 flex gap-2">
                                <div class="favorite-heart" data-property-id="{{ property.id }}" title="Добавить в избранное" onclick="if(window.favoritesManager) { window.favoritesManager.toggleFavorite('{{ property.id }}', this); event.stopPropagation(); }">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="comparison-btn w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="{{ property.id }}" title="Добавить к сравнению" onclick="toggleComparison('{{ property.id }}', this); event.stopPropagation();">
                                    <i class="fas fa-balance-scale text-gray-600 text-base"></i>
                                </div>
                                <div class="pdf-btn w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="{{ property.id }}" title="Скачать PDF" onclick="downloadPropertyPDF('{{ property.id }}'); event.stopPropagation();">
                                    <i class="fas fa-file-pdf text-red-600 text-base"></i>
                                </div>
                            </div>
                            <div class="absolute top-3 left-3 bg-[#FF5722] text-white text-xs font-semibold px-2 py-1 rounded z-20">
                                Кэшбек 5%
                            </div>
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-1 p-6">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <a href="{{ url_for('property_detail', property_id=property.id) }}" class="text-xl font-semibold hover:text-[#0088CC] transition">
                                        {% if property.rooms == 0 %}Студия{% elif property.type == 'пентхаус' %}Пентхаус{% elif property.type == 'апартаменты' %}Апартаменты{% elif property.type == 'таунхаус' %}Таунхаус{% elif property.type == 'дом' %}Дом{% else %}{{ property.rooms }}-к. квартира{% endif %}, {{ property.area }} м², {{ property.floor }}/{{ property.total_floors }} эт.
                                    </a>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <div class="text-gray-600 text-sm space-y-1">
                                            <p class="flex items-center">
                                                <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                                </svg>
                                                <a href="#" class="hover:text-[#0088CC] hover:underline">{{ property.residential_complex or 'ЖК ' + (property.complex_name or 'Без названия') }}</a>
                                            </p>
                                            <p class="flex items-center">
                                                <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                                </svg>
                                                {{ property.district }}, {{ property.residential_complex }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="flex flex-col items-end">
                                        <span class="text-sm text-gray-500 line-through">{{ "{:,.0f}".format(property.price + (property.price * 0.05)) }} ₽</span>
                                        <span class="property-price text-xl font-bold text-[#FF5722]">{{ "{:,.0f}".format(property.price) }} ₽</span>
                                        <span class="text-xs text-gray-500">(5% кэшбек {{ "{:,.0f}".format(property.price * 0.05) }} ₽)</span>
                                    </div>
                                    <span class="text-sm text-gray-500">{{ "{:,.0f}".format(property.price // property.area) }} ₽/м²</span>
                                </div>
                            </div>
                            
                            <div class="grid ${isGridView ? 'grid-cols-1 gap-2 mb-3' : 'grid-cols-2 md:grid-cols-3 gap-3 mb-6'}">
                                <!-- Compact info row -->
                                <div class="${isGridView ? 'grid grid-cols-2 gap-2 mb-2 pb-2 border-b border-gray-200' : 'col-span-2 md:col-span-3 grid grid-cols-3 gap-3 mb-3 pb-2 border-b border-gray-200'}">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 bg-gray-200 rounded-full mr-2 flex items-center justify-center text-xs font-bold text-gray-600">
                                            {{ property.developer[:3].upper() }}
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">Застройщик</div>
                                            <div class="font-semibold text-sm">{{ property.developer }}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 text-xs">Этажность</div>
                                        <div class="font-semibold text-sm">{{ property.floor }}/{{ property.total_floors }}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 text-xs">Ипотека от</div>
                                        <div class="font-semibold text-sm">3.5%</div>
                                    </div>
                                </div>
                                
                                <!-- Project details row -->
                                <div class="flex items-center col-span-1">
                                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
                                    </svg>
                                    <div>
                                        <div class="text-gray-500 text-xs">Площадь</div>
                                        <div class="font-semibold text-sm">{{ property.area }} м²</div>
                                    </div>
                                </div>
                                <div class="flex items-center col-span-1">
                                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                    </svg>
                                    <div>
                                        <div class="text-gray-500 text-xs">Отделка</div>
                                        <div class="font-semibold text-sm">{{ property.finish_type or 'Черновая' }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center col-span-1">
                                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <div>
                                        <div class="text-gray-500 text-xs">Срок сдачи</div>
                                        <div class="font-semibold text-sm">{{ property.completion_date or '2024' }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action buttons -->
                            <div class="flex gap-2 pt-4 border-t border-gray-100">
                                <button class="flex-1 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition compare-btn text-sm font-medium" data-property-id="{{ property.id }}">
                                    <i class="fas fa-balance-scale mr-1"></i>
                                    <span class="compare-text">Сравнить</span>
                                </button>
                                <a href="{{ url_for('property_pdf', property_id=property.id) }}" target="_blank" class="px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition text-sm font-medium" title="Скачать PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                {% if session.get('manager_id') %}
                                <button class="px-3 py-2 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-[#0088CC] hover:text-white transition text-sm recommend-btn" data-property-id="{{ property.id }}" data-property-name="{{ property.residential_complex }}" data-complex-name="{{ property.residential_complex }}" title="Рекомендовать клиенту">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- JavaScript Pagination Container -->
                <div id="pagination-container"></div>

                <!-- Server-side Pagination (fallback) -->
                {% if pagination and pagination.total_pages > 1 %}
                <div class="flex justify-center mt-12">
                    <div class="flex items-center gap-2">
                        <!-- Previous Page Button -->
                        {% if pagination.has_prev %}
                        <a href="{{ url_for('properties', page=pagination.prev_page) }}" 
                           class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                            Предыдущая
                        </a>
                        {% else %}
                        <span class="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-400 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                            Предыдущая
                        </span>
                        {% endif %}
                        
                        <!-- Page Numbers -->
                        {% set start_page = [1, pagination.page - 2]|max %}
                        {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
                        
                        {% if start_page > 1 %}
                        <a href="{{ url_for('properties', page=1) }}" 
                           class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">1</a>
                        {% if start_page > 2 %}
                        <span class="px-2 text-gray-400">...</span>
                        {% endif %}
                        {% endif %}
                        
                        {% for page_num in range(start_page, end_page + 1) %}
                        <a href="{{ url_for('properties', page=page_num) }}" 
                           class="px-3 py-2 border rounded-lg text-sm 
                                  {% if page_num == pagination.page %}bg-[#0088CC] text-white border-[#0088CC]{% else %}border-gray-300 hover:bg-gray-50{% endif %}">
                            {{ page_num }}
                        </a>
                        {% endfor %}
                        
                        {% if end_page < pagination.total_pages %}
                        {% if end_page < pagination.total_pages - 1 %}
                        <span class="px-2 text-gray-400">...</span>
                        {% endif %}
                        <a href="{{ url_for('properties', page=pagination.total_pages) }}" 
                           class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">{{ pagination.total_pages }}</a>
                        {% endif %}
                        
                        <!-- Next Page Button -->
                        {% if pagination.has_next %}
                        <a href="{{ url_for('properties', page=pagination.next_page) }}" 
                           class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                            Следующая
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                        {% else %}
                        <span class="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-400 flex items-center gap-2">
                            Следующая
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Results Info -->
                <div class="text-center mt-4 text-sm text-gray-600">
                    Показано {{ (pagination.page - 1) * pagination.per_page + 1 }}–{{ [pagination.page * pagination.per_page, pagination.total]|min }} 
                    из {{ pagination.total }} объектов
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Call-to-Action Section -->
<section class="py-16 bg-gradient-to-r from-[#0088CC] to-[#006699]">
    <div class="container mx-auto px-4 text-center">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-6">
                Получите персональную подборку квартир
            </h2>
            <p class="text-xl text-blue-100 mb-8">
                Наши эксперты подберут для вас лучшие варианты с максимальным кэшбеком до 500 000 ₽
            </p>
            
            <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-2xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ваше имя</label>
                        <input type="text" placeholder="Введите ваше имя" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                        <input type="tel" placeholder="+7 (___) ___-__-__" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Бюджет</label>
                    <select class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none">
                        <option>До 3 млн ₽</option>
                        <option>3-5 млн ₽</option>
                        <option>5-8 млн ₽</option>
                        <option>8-12 млн ₽</option>
                        <option>Свыше 12 млн ₽</option>
                    </select>
                </div>
                
                <button onclick="openApplicationModal();" class="w-full px-8 py-4 bg-gradient-to-r from-[#FF5722] to-[#E64A19] text-white font-bold rounded-xl hover:from-[#E64A19] hover:to-[#D84315] transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-gift mr-2"></i>
                    Получить подборку + кэшбек
                </button>
                
                <p class="text-sm text-gray-500 mt-4">
                    Бесплатно • Персональные предложения • Максимальный кэшбек
                </p>
            </div>
        </div>
    </div>
</section>

<script>
// Set authentication status immediately at the start
window.user_authenticated = {{ user_authenticated|tojson }};
window.manager_authenticated = {{ manager_authenticated|tojson }};
{% if current_manager %}
window.current_manager = {{ current_manager.to_dict()|tojson }};
{% endif %}

// Debug authentication status
console.log('Authentication status:', {
    user_authenticated: window.user_authenticated,
    manager_authenticated: window.manager_authenticated,
    current_manager: window.current_manager || null
});

let map;
let markers = [];
// Load all properties data for JavaScript filtering
let allProperties = {{ all_properties|tojson|safe }};
let filteredProperties = [];
let selectedRooms = new Set();
let currentSortBy = 'price-desc';
let currentPage = 1;
let itemsPerPage = 24; // Match backend pagination
let residentialComplexes = [];

// Completely remove old favorites system - now handled by FavoritesManager
// Clear localStorage to avoid conflicts
if (localStorage.getItem('favorites')) {
    localStorage.removeItem('favorites');
    console.log('Cleared old localStorage favorites');
}

// Favorites counter is now handled by FavoritesManager class
// function updateFavoritesCounter() - DEPRECATED

// Advanced Filters Object
let advancedFilters = {
    districts: [],
    developers: [],
    propertyTypes: [],
    priceMin: 0,
    priceMax: 0,
    roomTypes: [],
    distances: [],
    areas: [],
    directions: [],
    payments: [],
    areaFrom: 0,
    areaTo: 0
};

// Add galleries to properties for testing
allProperties.forEach((property, index) => {
    if (!property.gallery) {
        property.gallery = [
            property.image,
            `https://via.placeholder.com/400x300/FF5722/FFFFFF?text=Кухня`,
            `https://via.placeholder.com/400x300/4CAF50/FFFFFF?text=Спальня`,
            `https://via.placeholder.com/400x300/9C27B0/FFFFFF?text=Вид`
        ];
    }
});

// Enhanced search functionality with comprehensive suggestions for ALL parameters
function initializeSearch() {
    const searchInput = document.getElementById('property-search');
    const suggestionsContainer = document.getElementById('property-searchSuggestions');
    
    // Create comprehensive search suggestions covering ALL filter types
    const suggestions = {
        districts: ['Центральный', 'Западный', 'Карасунский', 'Прикубанский', 'Фестивальный'],
        rooms: ['Студия', '1-комнатная', '2-комнатная', '3-комнатная', '4+ комнатная'],
        propertyClass: ['Эконом', 'Комфорт', 'Бизнес', 'Премиум'],
        wallMaterial: ['Кирпич', 'Монолит', 'Панель', 'Газобетон'],
        floorsTotal: ['до 5 этажей', '6-10 этажей', '11-20 этажей', 'более 20 этажей'],
        completion: ['Готов', '1 кв. 2025', '2 кв. 2025', '3 кв. 2025', '4 кв. 2025', '2026'],
        properties: [],
        complexes: [],
        developers: [],
        streets: []
    };
    
    // Add property and complex data
    allProperties.forEach(property => {
        const propertyTitle = property.rooms == 0 ? 'Студия' : property.rooms + '-комн';
        suggestions.properties.push(propertyTitle + ' ' + property.area + ' м²');
        suggestions.complexes.push(property.residential_complex);
        suggestions.developers.push(property.developer);
        suggestions.streets.push(property.location);
    });
    
    // Add ЖК suggestions
    residentialComplexes.forEach(complex => {
        suggestions.complexes.push(complex.name);
        suggestions.developers.push(complex.developer);
        suggestions.streets.push(complex.location);
    });
    
    // Remove duplicates from each category
    Object.keys(suggestions).forEach(key => {
        suggestions[key] = [...new Set(suggestions[key])].filter(Boolean);
    });
    
    const allSuggestions = Object.values(suggestions).flat();
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length < 2) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
            return;
        }
        
        // Filter both property and ЖК suggestions
        const propertySuggestions = uniqueSuggestions
            .filter(suggestion => suggestion.toLowerCase().includes(query))
            .slice(0, 5);
            
        const complexSuggestions = residentialComplexes
            .filter(complex => 
                complex.name.toLowerCase().includes(query) ||
                complex.developer.toLowerCase().includes(query) ||
                complex.location.toLowerCase().includes(query)
            )
            .slice(0, 3);
        
        let suggestionHTML = '';
        
        if (propertySuggestions.length > 0) {
            suggestionHTML += propertySuggestions
                .map(suggestion => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                    <i class="fas fa-search mr-2 text-gray-400"></i>${suggestion}
                </div>`)
                .join('');
        }
        
        if (complexSuggestions.length > 0) {
            if (propertySuggestions.length > 0) {
                suggestionHTML += '<div class="border-t border-gray-200 my-1"></div>';
            }
            suggestionHTML += complexSuggestions
                .map(complex => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectComplexSuggestion('${complex.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-building mr-2 text-[#0088CC]"></i><strong>${complex.name}</strong><br>
                    <small class="text-gray-500 ml-6">${complex.developer} • ${complex.apartments_count} квартир</small>
                </div>`)
                .join('');
        }
        
        if (suggestionHTML && suggestionsContainer) {
            suggestionsContainer.innerHTML = suggestionHTML;
            suggestionsContainer.classList.remove('hidden');
        } else if (suggestionsContainer) {
            suggestionsContainer.classList.add('hidden');
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
        }
    });
}

// New smart search function
function performSmartSearch() {
    const searchValue = document.getElementById('property-search').value.trim();
    if (!searchValue) {
        alert('Введите поисковый запрос');
        return;
    }
    
    // Clear all current filters first
    clearAllFilters();
    
    // Try to detect and apply filters based on search
    const searchLower = searchValue.toLowerCase();
    
    // Check districts
    const districts = ['центральный', 'западный', 'карасунский', 'прикубанский', 'фестивальный'];
    districts.forEach(district => {
        if (searchLower.includes(district)) {
            const checkbox = document.querySelector(`input[data-filter-type="district"][value*="${district}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check property class
    const propertyClasses = ['эконом', 'комфорт', 'бизнес', 'премиум'];
    propertyClasses.forEach(cls => {
        if (searchLower.includes(cls)) {
            const checkbox = document.querySelector(`input[data-filter="property_class"][value*="${cls}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check wall materials
    const materials = ['кирпич', 'монолит', 'панель', 'газобетон'];
    materials.forEach(material => {
        if (searchLower.includes(material)) {
            const checkbox = document.querySelector(`input[data-filter="wall_material"][value*="${material}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Apply filters and search
    filterProperties();
    displayActiveFilters();
}

function selectSuggestion(suggestion, category) {
    document.getElementById('property-search').value = suggestion;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    
    // Auto-apply the selected filter
    if (category === 'district') {
        const checkbox = document.querySelector(`input[data-filter-type="district"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            filterProperties();
            displayActiveFilters();
        }
    } else if (category === 'developer') {
        const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${suggestion}"]`) ||
                        document.querySelector(`input[data-filter="developer"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            filterProperties();
            displayActiveFilters();
        }
    } else if (category === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    }
    
    console.log('Selected suggestion:', suggestion, 'Category:', category);
    
    // Apply search filter
    filterProperties();
    displayActiveFilters();
}

function selectComplexSuggestion(complexName) {
    document.getElementById('property-search').value = complexName;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    applyFilters();
}

// Room filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const roomButtons = document.querySelectorAll('.room-btn');
    
    roomButtons.forEach(button => {
        button.addEventListener('click', function() {
            const rooms = this.dataset.rooms;
            
            if (selectedRooms.has(rooms)) {
                selectedRooms.delete(rooms);
                this.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.add('border-gray-300', 'text-gray-700');
            } else {
                selectedRooms.add(rooms);
                this.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.remove('border-gray-300', 'text-gray-700');
            }
            
            applyFilters();
        });
    });
});

// Apply all filters
function resetAllFilters() {
    // Reset all form elements
    document.getElementById('property-search').value = '';
    document.getElementById('district-filter').value = '';
    document.getElementById('developer-filter').value = '';
    document.getElementById('price-from').value = '';
    document.getElementById('price-to').value = '';
    document.getElementById('area-from').value = '';
    document.getElementById('area-to').value = '';
    document.getElementById('property-type-filter').value = '';
    document.getElementById('completion-date-filter').value = '';
    document.getElementById('mortgage-filter').value = '';
    document.getElementById('sort-select').value = 'price-asc';
    
    // Reset room buttons
    selectedRooms.clear();
    document.querySelectorAll('.room-btn').forEach(button => {
        button.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
        button.classList.add('border-gray-300', 'text-gray-700');
    });
    
    // Hide reset button
    document.getElementById('resetFiltersBtn').style.display = 'none';
    
    // Clear URL parameters and redirect to clean properties page
    window.location.href = '/properties';
}

function applyFilters() {
    let filtered = [...allProperties];
    
    // Search filter
    const searchQuery = document.getElementById('property-search').value.toLowerCase().trim();
    if (searchQuery) {
        filtered = filtered.filter(property => {
            return property.title.toLowerCase().includes(searchQuery) ||
                   property.district.toLowerCase().includes(searchQuery) ||
                   (property.location && property.location.toLowerCase().includes(searchQuery)) ||
                   (property.full_address && property.full_address.toLowerCase().includes(searchQuery)) ||
                   property.developer.toLowerCase().includes(searchQuery) ||
                   (property.complex_name && property.complex_name.toLowerCase().includes(searchQuery));
        });
    }
    
    // District filter
    const district = document.getElementById('district-filter').value;
    if (district) {
        filtered = filtered.filter(property => property.district === district);
    }
    
    // Developer filter
    const developer = document.getElementById('developer-filter').value;
    if (developer) {
        filtered = filtered.filter(property => property.developer === developer);
    }
    
    // Price filter (unified with other filter function)
    const priceFromEl = document.getElementById('priceFrom') || document.getElementById('price-from');
    const priceToEl = document.getElementById('priceTo') || document.getElementById('price-to');
    const priceFromValue = priceFromEl ? parseFloat(priceFromEl.value || 0) : 0;
    const priceToValue = priceToEl ? parseFloat(priceToEl.value || 0) : 0;
    
    if (priceFromValue > 0 || priceToValue > 0) {
        filtered = filtered.filter(property => {
            const priceInMillions = parseFloat(property.price) / 1000000;
            if (priceFromValue > 0 && priceInMillions < priceFromValue) return false;
            if (priceToValue > 0 && priceInMillions > priceToValue) return false;
            return true;
        });
    }
    
    // Rooms filter
    if (selectedRooms.size > 0) {
        filtered = filtered.filter(property => {
            const rooms = property.rooms;
            for (let selectedRoom of selectedRooms) {
                if (selectedRoom === '4' && rooms >= 4) return true;
                if (selectedRoom === '0' && rooms === 0) return true;
                if (parseInt(selectedRoom) === rooms) return true;
            }
            return false;
        });
    }
    
    // Area filter
    const areaFrom = parseInt(document.getElementById('area-from').value) || 0;
    const areaTo = parseInt(document.getElementById('area-to').value) || Infinity;
    if (areaFrom > 0 || areaTo < Infinity) {
        filtered = filtered.filter(property => 
            property.area >= areaFrom && property.area <= areaTo
        );
    }
    
    // Property type filter
    const propertyType = document.getElementById('property-type-filter').value;
    if (propertyType) {
        filtered = filtered.filter(property => property.property_type === propertyType);
    }
    
    // Completion date filter
    const completionDate = document.getElementById('completion-date-filter').value;
    if (completionDate) {
        filtered = filtered.filter(property => property.completion_date === completionDate);
    }
    
    // Mortgage filter
    const mortgage = document.getElementById('mortgage-filter').value;
    if (mortgage) {
        filtered = filtered.filter(property => {
            switch (mortgage) {
                case 'available':
                    return property.mortgage_available === true;
                case 'preferential':
                    return property.preferential_mortgage === true;
                case 'family':
                    return property.family_mortgage === true;
                case 'it':
                    return property.it_mortgage === true;
                default:
                    return true;
            }
        });
    }
    
    filteredProperties = filtered;
    currentPage = 1; // Reset to first page when filtering
    updatePropertiesList(filtered);
    updateResultsCount(filtered.length);
    
    // Show/hide reset button based on active filters
    checkActiveFilters();
}

function checkActiveFilters() {
    const hasActiveFilters = (
        document.getElementById('property-search').value.trim() !== '' ||
        document.getElementById('district-filter').value !== '' ||
        document.getElementById('developer-filter').value !== '' ||
        document.getElementById('price-from').value !== '' ||
        document.getElementById('price-to').value !== '' ||
        document.getElementById('area-from').value !== '' ||
        document.getElementById('area-to').value !== '' ||
        document.getElementById('property-type-filter').value !== '' ||
        document.getElementById('completion-date-filter').value !== '' ||
        document.getElementById('mortgage-filter').value !== '' ||
        selectedRooms.size > 0
    );
    
    const resetBtn = document.getElementById('resetFiltersBtn');
    if (resetBtn) {
        resetBtn.style.display = hasActiveFilters ? 'block' : 'none';
    }
}

// Update properties list display with pagination
function updatePropertiesList(properties) {
    const listContainer = document.getElementById('properties-container');
    
    if (!listContainer) {
        console.warn('Properties container not found - display mode may not be available');
        return;
    }
    
    if (properties.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">🔍</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Квартиры не найдены</h3>
                <p class="text-gray-500">Попробуйте изменить параметры поиска</p>
            </div>
        `;
        updatePaginationControls(0, 0);
        return;
    }
    
    // Calculate pagination
    const totalItems = properties.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    const paginatedProperties = properties.slice(startIndex, endIndex);
    
    // Get current view mode from data attribute
    const isGridView = listContainer.getAttribute('data-view-mode') === 'grid';
    
    if (isGridView) {
        listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    } else {
        listContainer.className = 'space-y-6';
    }
    
    console.log(`Current view mode: ${isGridView ? 'grid' : 'list'}, Page: ${currentPage}/${totalPages}, Showing: ${startIndex + 1}-${endIndex} of ${totalItems}`);
    // Render paginated properties
    listContainer.innerHTML = paginatedProperties.map(property => `
        <!-- Property Card (Original Design) -->
        <div class="property-card bg-white rounded-lg shadow-sm overflow-hidden w-full ${isGridView ? 'flex flex-col h-full' : 'flex flex-col md:flex-row'}" 
             data-type="${property.type}" 
             data-rooms="${property.rooms}" 
             data-price="${property.price}" 
             data-district="${property.district}" 
             data-developer="${property.developer}"
             data-complex="${property.complex_name || 'Не указан'}"
             data-property-type="${property.property_type || property.type}">
            
            <!-- Image Gallery -->
            <div class="relative ${isGridView ? 'w-full h-48 flex-shrink-0' : 'md:w-96 w-full h-64 md:h-auto'} overflow-hidden group">
                <div class="carousel-container w-full h-full relative" data-property-id="${property.id}">
                    ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                        <div class="carousel-slide absolute inset-0 transition-opacity duration-300 ${index === 0 ? '' : 'opacity-0'}" data-slide="${index}">
                            <img src="${image}" alt="${property.title} - фото ${index + 1}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                        </div>
                    `).join('')}
                    
                    ${(property.gallery && property.gallery.length > 1) ? `
                    <!-- Navigation arrows -->
                    <button class="carousel-prev absolute left-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center hover:bg-black/50 transition z-30 opacity-0 group-hover:opacity-100" onclick="prevImageSlide(this)">
                        <i class="fas fa-chevron-left text-sm"></i>
                    </button>
                    <button class="carousel-next absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center hover:bg-black/50 transition z-30 opacity-0 group-hover:opacity-100" onclick="nextImageSlide(this)">
                        <i class="fas fa-chevron-right text-sm"></i>
                    </button>
                    
                    <!-- Dots indicator -->
                    <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex gap-1 z-30 opacity-0 group-hover:opacity-100 transition">
                        ${property.gallery ? property.gallery.map((_, index) => `
                            <button class="w-2 h-2 rounded-full bg-white/50 hover:bg-white/80 transition ${index === 0 ? 'bg-white/80' : ''}" onclick="goToImageSlide(this, ${index})"></button>
                        `).join('') : ''}
                    </div>
                    ` : ''}
                </div>
                <div class="absolute top-3 left-3 bg-[#FF5722] text-white text-xs font-semibold px-2 py-1 rounded z-20">
                    Кэшбек 5%
                </div>
                <!-- Overlay elements -->
                <div class="absolute top-3 right-3 z-20 flex gap-2">
                    <div class="favorite-heart" data-property-id="${property.id}" title="Добавить в избранное">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="comparison-btn w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="${property.id}" title="Добавить к сравнению" onclick="toggleComparison('${property.id}', this); event.stopPropagation();">
                        <i class="fas fa-balance-scale text-gray-600 text-base"></i>
                    </div>
                    <div class="pdf-btn w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="${property.id}" title="Скачать PDF" onclick="downloadPropertyPDF('${property.id}'); event.stopPropagation();">
                        <i class="fas fa-file-pdf text-red-600 text-base"></i>
                    </div>
                </div>
            </div>
            
            <!-- Info -->
            <div class="flex-1 ${isGridView ? 'p-4' : 'p-6'}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <a href="/object/${property.id}" class="${isGridView ? 'text-base font-medium' : 'text-xl font-semibold'} hover:text-[#0088CC] transition">
                            ${property.type === 'студия' ? 'Студия' : property.type === 'пентхаус' ? 'Пентхаус' : property.type === 'апартаменты' ? 'Апартаменты' : property.type === 'таунхаус' ? 'Таунхаус' : property.type === 'дом' ? 'Дом' : `${property.rooms}-к. квартира`}, ${property.area} м², ${property.floor}/${property.total_floors} эт.
                        </a>
                        <div class="flex items-center space-x-2 mt-1">
                            <div class="text-gray-600 text-sm space-y-1">
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    <a href="#" class="hover:text-[#0088CC] hover:underline">${property.complex_name || 'ЖК ' + property.title}</a>
                                </p>
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                    </svg>
                                    ${property.district}, ${property.complex_name}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex flex-col items-end">
                            <span class="text-sm text-gray-500 line-through">${(property.price + (property.price * 0.05)).toLocaleString('ru-RU')} ₽</span>
                            <span class="property-price text-xl font-bold text-[#FF5722]">${property.price.toLocaleString('ru-RU')} ₽</span>
                            <span class="text-xs text-gray-500">(5% кэшбек ${(property.price * 0.05).toLocaleString('ru-RU')} ₽)</span>
                        </div>
                        <span class="text-sm text-gray-500">${Math.round(property.price / property.area).toLocaleString('ru-RU')} ₽/м²</span>
                    </div>
                </div>
                
                <div class="grid ${isGridView ? 'grid-cols-1 gap-2 mb-3' : 'grid-cols-2 md:grid-cols-3 gap-3 mb-6'}">
                    <!-- Compact info row -->
                    <div class="${isGridView ? 'grid grid-cols-2 gap-2 mb-2 pb-2 border-b border-gray-200' : 'col-span-2 md:col-span-3 grid grid-cols-3 gap-3 mb-3 pb-2 border-b border-gray-200'}">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-gray-200 rounded-full mr-2 flex items-center justify-center text-xs font-bold text-gray-600">
                                ${property.developer ? property.developer.substring(0,3).toUpperCase() : 'ИБ'}
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Застройщик</div>
                                <div class="font-semibold text-sm">${property.developer}</div>
                            </div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Этажность</div>
                            <div class="font-semibold text-sm">${property.floor}/${property.total_floors}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Ипотека от</div>
                            <div class="font-semibold text-sm">3.5%</div>
                        </div>
                    </div>
                    
                    <!-- Project details row -->
                    <div class="${isGridView ? 'flex items-center' : 'flex items-center col-span-1'}">
                        <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
                        </svg>
                        <div>
                            <div class="text-gray-500 text-xs">Площадь</div>
                            <div class="font-semibold text-sm">${property.area} м²</div>
                        </div>
                    </div>
                    <div class="${isGridView ? 'flex items-center' : 'flex items-center col-span-1'}">
                        <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                        </svg>
                        <div>
                            <div class="text-gray-500 text-xs">Отделка</div>
                            <div class="font-semibold text-sm">${property.finish_type || 'Черновая'}</div>
                        </div>
                    </div>
                    <div class="${isGridView ? 'flex items-center' : 'flex items-center col-span-1'}">
                        <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <div>
                            <div class="text-gray-500 text-xs">Срок сдачи</div>
                            <div class="font-semibold text-sm">${property.completion_date || '2024'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Action buttons -->
                <div class="${isGridView ? 'flex flex-col gap-2 pt-3 border-t border-gray-100' : 'flex gap-2 pt-4 border-t border-gray-100'}">
                    <div class="${isGridView ? 'flex gap-2' : 'flex gap-2 flex-1'}">
                        <button class="${isGridView ? 'flex-1 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition compare-btn text-sm font-medium' : 'flex-1 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition compare-btn text-sm font-medium'}" data-property-id="${property.id}">
                            <i class="fas fa-balance-scale mr-1"></i>
                            <span class="compare-text">Сравнить</span>
                        </button>
                        <a href="/object/${property.id}/pdf" target="_blank" class="px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition text-sm font-medium" title="Скачать PDF">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                    </div>
                    ${window.manager_authenticated ? `
                    <button class="px-3 py-2 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-[#0088CC] hover:text-white transition text-sm recommend-btn ${isGridView ? 'w-full' : ''}" data-property-id="${property.id}" data-property-name="${property.name}" data-complex-name="${property.complex_name}" title="Рекомендовать клиенту">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    // Update pagination controls
    updatePaginationControls(totalItems, totalPages);
    
    // Initialize favorites and comparison buttons after rendering
    setTimeout(() => {
        initializeAllButtons();
        console.log('Property list updated, buttons initialized');
    }, 50);
}

// Advanced Filters System  
let activeFilters = {};
let originalProperties = [...allProperties];

function initializeAdvancedFilters() {
    // Clear all filters button
    const clearAllBtn = document.getElementById('clearAllFilters');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function() {
            clearAllActiveFilters();
        });
    }
}

// Clear all active filters
function clearAllActiveFilters() {
    // Remove active class from all filter buttons
    document.querySelectorAll('.filter-option-btn.active').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Uncheck all checkboxes
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Clear price inputs
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.value = '';
    });
    
    // Reset filters and refresh results
    activeFilters = {};
    filterProperties();
}

// Initialize dropdown filters functionality
function initializeDropdownFilters() {
    // Remove existing listeners to prevent duplicates
    const existingListeners = document.querySelectorAll('[data-dropdown-initialized]');
    existingListeners.forEach(el => el.removeAttribute('data-dropdown-initialized'));
    
    // Get property filter buttons - include quick filters but exclude header dropdowns  
    const searchSection = document.querySelector('section.py-8.bg-gray-50');
    const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
    
    if (!searchSection && !propertySection) return;
    
    // Get quick filter buttons from search section and advanced filter buttons from property section
    let filterButtons = [];
    if (searchSection) {
        filterButtons = filterButtons.concat(Array.from(searchSection.querySelectorAll('.dropdown .dropdown-btn')));
    }
    if (propertySection) {
        filterButtons = filterButtons.concat(Array.from(propertySection.querySelectorAll('.filter-dropdown .filter-option-btn, #toggleAllFilters')));
    }
    
    // Also get buttons from advanced filters section
    const advancedSection = document.querySelector('#advancedFiltersSection');
    if (advancedSection) {
        filterButtons = filterButtons.concat(Array.from(advancedSection.querySelectorAll('.filter-dropdown .filter-option-btn')));
    }
    
    filterButtons.forEach(button => {
        // Skip if already initialized
        if (button.hasAttribute('data-dropdown-initialized')) return;
        button.setAttribute('data-dropdown-initialized', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.id === 'toggleAllFilters') {
                // Handle "Все фильтры" button specially
                toggleAdvancedFilters();
                return;
            }
            
            const dropdown = this.closest('.filter-dropdown') || this.closest('.dropdown');
            let menu = null;
            
            if (dropdown) {
                menu = dropdown.querySelector('.dropdown-menu');
            }
            
            if (!menu && dropdown) {
                // Also check for filter-dropdown-menu class for advanced filters
                menu = dropdown.querySelector('.filter-dropdown-menu');
            }
            
            if (menu) {
                // Check current menu state BEFORE closing others
                let isCurrentMenuOpen = false;
                if (menu.classList.contains('dropdown-menu')) {
                    isCurrentMenuOpen = menu.classList.contains('open');
                } else if (menu.classList.contains('filter-dropdown-menu')) {
                    isCurrentMenuOpen = !menu.classList.contains('hidden');
                }
                
                // Close all dropdowns including the current one
                document.querySelectorAll('.dropdown-menu.open, .filter-dropdown-menu:not(.hidden)').forEach(openMenu => {
                    openMenu.classList.remove('open');
                    openMenu.classList.add('hidden');
                });
                
                // If the clicked menu was closed, open it
                if (!isCurrentMenuOpen) {
                    if (menu.classList.contains('dropdown-menu')) {
                        menu.classList.add('open');
                        menu.classList.remove('hidden');
                    } else if (menu.classList.contains('filter-dropdown-menu')) {
                        menu.classList.remove('hidden');
                    }
                    console.log('Dropdown opened');
                } else {
                    console.log('Dropdown closed');
                }
            }
        });
    });
    
    // Remove existing document click listener and add fresh one
    if (window.dropdownDocumentListener) {
        document.removeEventListener('click', window.dropdownDocumentListener);
    }
    
    window.dropdownDocumentListener = function(e) {
        // Only close property filter dropdowns, never touch header
        const searchSection = document.querySelector('section.py-8.bg-gray-50');
        const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
        
        if (!e.target.closest('.filter-dropdown') && !e.target.closest('.dropdown') && !e.target.closest('#allFiltersPanel') && !e.target.closest('header') && !e.target.closest('nav')) {
            // Close dropdowns within search section (quick filters)
            if (searchSection) {
                searchSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
            
            // Close dropdowns within property section (advanced filters)
            if (propertySection) {
                propertySection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                propertySection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
                propertySection.querySelectorAll('#allFiltersPanel').forEach(panel => {
                    panel.classList.add('hidden');
                });
            }
            
            // Close dropdowns within advanced filters section
            const advancedSection = document.querySelector('#advancedFiltersSection');
            if (advancedSection) {
                advancedSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                advancedSection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        }
    };
    
    document.addEventListener('click', window.dropdownDocumentListener);
}

// Handle room filter changes
function handleRoomFilterChange() {
    // Add small delay to prevent rapid fire events
    if (window.roomFilterTimeout) {
        clearTimeout(window.roomFilterTimeout);
    }
    
    window.roomFilterTimeout = setTimeout(() => {
        const checkedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        console.log('Room filters changed:', checkedRooms);
        
        // Update button text
        const buttonText = document.getElementById('roomsFilterText');
        if (buttonText) {
            if (checkedRooms.length === 0) {
                buttonText.textContent = 'Тип квартиры';
            } else if (checkedRooms.length === 1) {
                buttonText.textContent = checkedRooms[0];
            } else {
                buttonText.textContent = `${checkedRooms.length} типов`;
            }
        }
        
        // Apply filter immediately
        filterProperties();
        displayActiveFilters();
    }, 100);
}

// Apply filters with proper function name
function applyFiltersFixed() {
    console.log('Applying filters...');
    filterProperties();
}

// Apply price filter
function applyPriceFilter() {
    const priceFrom = document.getElementById('priceFrom').value;
    const priceTo = document.getElementById('priceTo').value;
    
    console.log('Price filter:', priceFrom, 'to', priceTo);
    
    // Update button text
    const buttonText = document.getElementById('priceFilterText');
    if (priceFrom || priceTo) {
        let text = 'Цена ';
        if (priceFrom) text += `от ${priceFrom}млн `;
        if (priceTo) text += `до ${priceTo}млн`;
        buttonText.textContent = text.trim() + ' ₽';
    } else {
        buttonText.textContent = 'Цена от-до, ₽';
    }
    
    // Apply filter
    filterProperties();
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="price"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Toggle advanced filters section
function toggleAdvancedFilters() {
    const section = document.getElementById('advancedFiltersSection');
    if (section) {
        section.classList.toggle('hidden');
        console.log('Advanced filters toggled:', !section.classList.contains('hidden'));
    }
}

// Enhanced filter properties function with room filtering
function filterProperties() {
    // Prevent concurrent filtering operations
    if (window.isFiltering) return;
    window.isFiltering = true;
    
    try {
        if (!allProperties || allProperties.length === 0) {
            console.log('No properties to filter');
            return;
        }
        
        // Get room filters
        const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        
        // Get price filters  
        const priceFromEl = document.getElementById('priceFrom');
        const priceToEl = document.getElementById('priceTo');
        const priceFrom = priceFromEl ? parseFloat(priceFromEl.value || 0) : 0;
        const priceTo = priceToEl ? parseFloat(priceToEl.value || 0) : 0;
        
        // Get completion date filters
        const selectedCompletionDates = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
        
        console.log('Filtering with:', {
            rooms: selectedRooms,
            priceFrom: priceFrom,
            priceTo: priceTo,
            completion: selectedCompletionDates
        });
        
        // Debug: show some sample property data
        if (allProperties.length > 0) {
            console.log('Sample property for debugging:', {
                price: allProperties[0].price,
                priceInMillions: allProperties[0].price / 1000000,
                completion_date: allProperties[0].completion_date,
                rooms: allProperties[0].rooms,
                type: allProperties[0].type
            });
        }
        
        let filteredProperties = allProperties.filter(property => {
            // Room filter (merge quick and advanced filters)
            const allSelectedRooms = [...selectedRooms];
            if (advancedFilters.roomTypes && advancedFilters.roomTypes.length > 0) {
                allSelectedRooms.push(...advancedFilters.roomTypes);
            }
            
            if (allSelectedRooms.length > 0) {
                const match = allSelectedRooms.some(room => {
                    if (room === 'студия') return property.rooms === 0 || property.type === 'Студия';
                    if (room === '1-комн') return property.rooms === 1;
                    if (room === '2-комн') return property.rooms === 2;
                    if (room === '3-комн') return property.rooms === 3;
                    if (room === '4+-комн') return property.rooms >= 4;
                    return false;
                });
                if (!match) return false;
            }
            
            // Price filter (convert to millions for comparison)
            const priceInMillions = parseFloat(property.price) / 1000000;
            if (priceFrom > 0 && priceInMillions < priceFrom) return false;
            if (priceTo > 0 && priceInMillions > priceTo) return false;
            
            // Completion date filter
            if (selectedCompletionDates.length > 0) {
                const match = selectedCompletionDates.some(date => {
                    if (date === 'Сдан') {
                        return property.completion_date === 'Сдан' || 
                               property.status === 'ready' || 
                               property.completion_date === 'Готов' ||
                               property.completion_date === 'Сдано';
                    }
                    // For years like "2024", "2025" - check if completion_date contains the year
                    if (date.match(/^\d{4}$/)) {
                        return property.completion_date && property.completion_date.includes(date);
                    }
                    return property.completion_date === date;
                });
                if (!match) return false;
            }
            
            // Advanced filters integration
            // District filter (from advanced filters)
            if (advancedFilters.districts && advancedFilters.districts.length > 0) {
                const match = advancedFilters.districts.some(district => {
                    return property.district === district;
                });
                if (!match) return false;
            }
            
            // Developer filter (from advanced filters)
            if (advancedFilters.developers && advancedFilters.developers.length > 0) {
                const match = advancedFilters.developers.some(developer => {
                    return property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Property type filter (from advanced filters)
            if (advancedFilters.propertyTypes && advancedFilters.propertyTypes.length > 0) {
                const match = advancedFilters.propertyTypes.some(type => {
                    return property.type === type || property.property_type === type;
                });
                if (!match) return false;
            }
            
            // Area filter (from advanced filters)
            if (advancedFilters.areas && advancedFilters.areas.length > 0) {
                const match = advancedFilters.areas.some(areaRange => {
                    const area = parseFloat(property.area);
                    if (areaRange === '30-50') return area >= 30 && area <= 50;
                    if (areaRange === '50-70') return area >= 50 && area <= 70;
                    if (areaRange === '70-100') return area >= 70 && area <= 100;
                    if (areaRange === '100+') return area > 100;
                    return false;
                });
                if (!match) return false;
            }
            
            // Area range filter (from advanced filters)
            if (advancedFilters.areaFrom > 0 || advancedFilters.areaTo > 0) {
                const area = parseFloat(property.area);
                if (advancedFilters.areaFrom > 0 && area < advancedFilters.areaFrom) return false;
                if (advancedFilters.areaTo > 0 && area > advancedFilters.areaTo) return false;
            }
            
            // Distance filter (from advanced filters)
            if (advancedFilters.distances && advancedFilters.distances.length > 0) {
                const match = advancedFilters.distances.some(distanceRange => {
                    // Mock distance calculation - in real app would be calculated from coordinates
                    const mockDistance = Math.random() * 20; // 0-20 km
                    if (distanceRange === '0-5') return mockDistance <= 5;
                    if (distanceRange === '5-10') return mockDistance > 5 && mockDistance <= 10;
                    if (distanceRange === '10-15') return mockDistance > 10 && mockDistance <= 15;
                    if (distanceRange === '15+') return mockDistance > 15;
                    return false;
                });
                if (!match) return false;
            }
            
            // Payment methods filter (from advanced filters)
            if (advancedFilters.payments && advancedFilters.payments.length > 0) {
                // Mock payment methods - in real app would check property payment options
                const match = advancedFilters.payments.some(payment => {
                    return true; // All properties support all payment methods for now
                });
                if (!match) return false;
            }
            
            // Direction filter (from advanced filters)
            if (advancedFilters.directions && advancedFilters.directions.length > 0) {
                // Mock direction - in real app would check property orientation
                const directions = ['север', 'юг', 'восток', 'запад', 'юго-восток', 'юго-запад', 'северо-восток', 'северо-запад'];
                const propertyDirection = directions[property.id % directions.length];
                const match = advancedFilters.directions.includes(propertyDirection);
                if (!match) return false;
            }
            

            
            return true;
        });
        
        console.log(`Filtered ${filteredProperties.length} properties from ${allProperties.length} total`);
        
        // Store globally for other functions
        window.filteredProperties = filteredProperties;
        
        // Update results using the same display function as original
        currentPage = 1; // Reset to first page when filtering
        updatePropertiesList(filteredProperties);
        updateResultsCount(filteredProperties.length);
        
        // Update active filters display
        displayActiveFilters();
        
        // Initialize buttons after filtering
        setTimeout(() => {
            initializeAllButtons();
            console.log('Buttons reinitialized after filtering');
        }, 50);
        
    } finally {
        window.isFiltering = false;
    }
}

// Update results counter
function updateResultsCount(count) {
    const counter = document.getElementById('resultsCounter');
    if (counter) {
        counter.textContent = `${count} объектов`;
    }
    
    // Also update the main results counter in the header
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
        resultsCount.textContent = count;
    }
}

// Update pagination controls
function updatePaginationControls(totalItems, totalPages) {
    const paginationContainer = document.getElementById('pagination-container');
    if (!paginationContainer) return;
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }
    
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
    
    let paginationHTML = `
        <div class="flex justify-between items-center bg-white rounded-lg shadow-sm border border-gray-200 p-4 mt-6">
            <div class="text-sm text-gray-600">
                Показано <span class="font-semibold">${startIndex}-${endIndex}</span> из <span class="font-semibold">${totalItems}</span> объектов
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="goToPage(${currentPage - 1})" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                    Предыдущая
                </button>
    `;
    
    // Page numbers
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    if (startPage > 1) {
        paginationHTML += `<button onclick="goToPage(1)" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="px-2">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button onclick="goToPage(${i})" class="px-3 py-2 border rounded-lg transition ${i === currentPage ? 'bg-[#0088CC] text-white' : 'hover:bg-gray-50'}">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="px-2">...</span>`;
        }
        paginationHTML += `<button onclick="goToPage(${totalPages})" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">${totalPages}</button>`;
    }
    
    paginationHTML += `
                <button onclick="goToPage(${currentPage + 1})" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages ? 'disabled' : ''}>
                    Следующая
                </button>
            </div>
        </div>
    `;
    
    paginationContainer.innerHTML = paginationHTML;
}

// Go to specific page
function goToPage(page) {
    if (page < 1 || page > Math.ceil(filteredProperties.length / itemsPerPage)) return;
    
    currentPage = page;
    updatePropertiesList(filteredProperties.length > 0 ? filteredProperties : allProperties);
    
    // Scroll to top of results
    const resultsSection = document.querySelector('#properties-container');
    if (resultsSection) {
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Advanced Filters Functions
// advancedFilters already declared above

function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    advancedFilters.districts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.roomTypes = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
    
    // Update the quick filters to match advanced filters
    if (advancedFilters.districts.length > 0) {
        // Update district dropdown if exists
        const districtSelect = document.querySelector('select[name="district"]');
        if (districtSelect) {
            districtSelect.value = advancedFilters.districts[0];
        }
    }
    
    // Apply the unified filter logic
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
    
    // Hide advanced filters panel
    toggleAdvancedFilters();
}

function clearAllAdvancedFilters() {
    console.log('Clearing all advanced filters...');
    
    // Clear all checkboxes in advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset advanced filters object
    advancedFilters = {
        districts: [],
        developers: [],
        propertyTypes: [],
        priceMin: 0,
        priceMax: 0,
        roomTypes: [],
        distances: [],
        areas: [],
        directions: [],
        payments: [],
        areaFrom: 0,
        areaTo: 0
    };
    
    // Clear main filter checkboxes too
    document.querySelectorAll('input[data-filter-type="rooms"]:checked').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Update results display
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
}

function updateAdvancedFiltersResultsCount() {
    const resultCountElement = document.getElementById('advancedResultsCount');
    if (resultCountElement) {
        const count = filteredProperties.length || allProperties.length;
        resultCountElement.textContent = `${count} квартир найдено`;
    }
}

// Save current filters function
function saveCurrentFilters() {
    console.log('Saving current filters state...');
    toggleAdvancedFilters(); // Just close the panel for now
}

// Initialize advanced filters dropdowns
function initializeAdvancedFilters() {
    // Handle dropdown toggle for advanced filters
    document.querySelectorAll('#advancedFiltersSection .filter-option-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdown = this.closest('.filter-dropdown');
            if (!dropdown) return;
            
            const menu = dropdown.querySelector('.dropdown-menu');
            if (!menu) return;
            
            // Close other dropdowns
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(otherMenu => {
                if (otherMenu !== menu) {
                    otherMenu.classList.add('hidden');
                }
            });
            
            // Toggle current dropdown
            menu.classList.toggle('hidden');
            console.log('Advanced dropdown toggled');
        });
    });
    
    // Handle checkbox changes in advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('Advanced filter checkbox changed:', this.value, this.checked);
            
            // Collect current advanced filter values including new filters
            advancedFilters.districts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
            advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
            advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
            advancedFilters.propertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
            advancedFilters.wallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
            advancedFilters.floorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
            advancedFilters.propertyType = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
            advancedFilters.salesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
            advancedFilters.parking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
            advancedFilters.elevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
            advancedFilters.registration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
            advancedFilters.nearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
            advancedFilters.windowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
            advancedFilters.specialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
            advancedFilters.worldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
            
            // Update global activeFilters object with all new filters
            activeFilters.propertyClass = advancedFilters.propertyClass;
            activeFilters.wallMaterial = advancedFilters.wallMaterial;
            activeFilters.floorsTotal = advancedFilters.floorsTotal;
            activeFilters.propertyType = advancedFilters.propertyType;
            activeFilters.salesStart = advancedFilters.salesStart;
            activeFilters.parking = advancedFilters.parking;
            activeFilters.elevator = advancedFilters.elevator;
            activeFilters.registration = advancedFilters.registration;
            activeFilters.nearbyPlaces = advancedFilters.nearbyPlaces;
            activeFilters.windowView = advancedFilters.windowView;
            activeFilters.specialApartments = advancedFilters.specialApartments;
            activeFilters.worldSides = advancedFilters.worldSides;
            advancedFilters.roomTypes = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
            advancedFilters.distances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
            advancedFilters.areas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
            advancedFilters.directions = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
            advancedFilters.payments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
            
            // Get area range inputs
            const areaFrom = document.getElementById('areaFrom')?.value;
            const areaTo = document.getElementById('areaTo')?.value;
            if (areaFrom || areaTo) {
                advancedFilters.areaFrom = parseFloat(areaFrom) || 0;
                advancedFilters.areaTo = parseFloat(areaTo) || 0;
            }
            
            // Real-time filtering
            filterProperties();
            
            // Update active filters display
            displayActiveFilters();
            
            // Real-time update of filter count
            updateAdvancedFiltersResultsCount();
            
            // Initialize buttons after filtering
            setTimeout(() => {
                initializeAllButtons();
                console.log('Buttons reinitialized after advanced filtering');
            }, 50);
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#advancedFiltersSection .filter-dropdown')) {
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
}

// Display active filters
function displayActiveFilters() {
    const activeFiltersList = document.getElementById('activeFiltersList');
    const clearButton = document.getElementById('clearAllFiltersBtn');
    
    if (!activeFiltersList) return;
    
    // Get active room filters
    const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
    
    // Get price filters
    const priceFrom = document.getElementById('priceFrom')?.value;
    const priceTo = document.getElementById('priceTo')?.value;
    
    // Get completion filters
    const selectedCompletionDates = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
    
    // Get advanced filters
    const selectedDistances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
    const selectedAreas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
    const selectedDirections = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
    const selectedPayments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
    
    // Get new advanced filters
    const selectedPropertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
    const selectedWallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
    const selectedFloorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
    const selectedPropertyTypes = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
    const selectedSalesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
    const selectedParking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
    const selectedElevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
    const selectedRegistration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
    const selectedNearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
    const selectedWindowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
    const selectedSpecialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
    const selectedWorldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
    const selectedDistricts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
    const selectedDevelopers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    const selectedOldPropertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    const selectedAdvancedRooms = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
    
    // Get area range inputs
    const areaFromInput = document.getElementById('areaFrom')?.value;
    const areaToInput = document.getElementById('areaTo')?.value;
    
    // Clear existing filters
    activeFiltersList.innerHTML = '';
    
    let hasFilters = false;
    
    // Add room filters
    selectedRooms.forEach(room => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            ${room}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('rooms', '${room}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add price filter
    if (priceFrom || priceTo) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        let priceText = 'Цена ';
        if (priceFrom) priceText += `от ${priceFrom}млн `;
        if (priceTo) priceText += `до ${priceTo}млн`;
        chip.innerHTML = `
            ${priceText.trim()}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('price', '')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    }
    
    // Add completion filters
    selectedCompletionDates.forEach(date => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            ${date}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('completion', '${date}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add distance filters
    selectedDistances.forEach(distance => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            До центра: ${distance} км
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('distance', '${distance}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add area filters
    selectedAreas.forEach(area => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Площадь: ${area}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('area', '${area}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add area range filter
    if (areaFromInput || areaToInput) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        let areaText = 'Площадь ';
        if (areaFromInput) areaText += `от ${areaFromInput}м² `;
        if (areaToInput) areaText += `до ${areaToInput}м²`;
        chip.innerHTML = `
            ${areaText.trim()}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('areaRange', '')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    }
    
    // Add direction filters
    selectedDirections.forEach(direction => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Сторона: ${direction}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('direction', '${direction}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add payment filters
    selectedPayments.forEach(payment => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Оплата: ${payment}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('payment', '${payment}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add district filters
    selectedDistricts.forEach(district => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Район: ${district}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('district', '${district}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add developer filters
    selectedDevelopers.forEach(developer => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Застройщик: ${developer}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('developer', '${developer}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add property type filters
    selectedPropertyTypes.forEach(type => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Тип: ${type}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('propertyType', '${type}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add advanced room filters
    selectedAdvancedRooms.forEach(room => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            ${room}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('advancedRooms', '${room}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add property class filters (NEW)
    selectedPropertyClass.forEach(cls => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Класс: ${cls}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('propertyClass', '${cls}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add wall material filters (NEW)
    selectedWallMaterial.forEach(material => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Материал: ${material}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('wallMaterial', '${material}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add floors total filters (NEW)
    selectedFloorsTotal.forEach(floors => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Этажей: ${floors}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('floorsTotal', '${floors}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add property type filters (NEW)
    selectedPropertyTypes.forEach(type => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Тип: ${type}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('propertyType2', '${type}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add sales start filters (NEW)
    selectedSalesStart.forEach(start => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Продажи: ${start}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('salesStart', '${start}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add parking filters (NEW)
    selectedParking.forEach(parking => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Паркинг: ${parking}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('parking', '${parking}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add elevator filters (NEW)
    selectedElevator.forEach(elevator => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Лифт: ${elevator}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('elevator', '${elevator}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add registration filters (NEW)
    selectedRegistration.forEach(reg => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Прописка: ${reg}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('registration', '${reg}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add nearby places filters (NEW)
    selectedNearbyPlaces.forEach(place => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Рядом: ${place}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('nearbyPlaces', '${place}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add window view filters (NEW)
    selectedWindowView.forEach(view => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Вид: ${view}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('windowView', '${view}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add special apartments filters (NEW)
    selectedSpecialApartments.forEach(special => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Особая: ${special}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('specialApartments', '${special}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add world sides filters (NEW)
    selectedWorldSides.forEach(side => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Сторона: ${side}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('worldSides', '${side}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Show/hide clear button
    if (clearButton) {
        clearButton.classList.toggle('hidden', !hasFilters);
    }
}

// Remove individual filter
function removeFilter(type, value) {
    if (type === 'rooms') {
        const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRoomFilterChange();
    } else if (type === 'price') {
        document.getElementById('priceFrom').value = '';
        document.getElementById('priceTo').value = '';
        document.getElementById('priceFilterText').textContent = 'Цена от-до, ₽';
    } else if (type === 'completion') {
        const checkbox = document.querySelector(`input[data-filter-type="completion"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'distance') {
        const checkbox = document.querySelector(`input[data-filter="distance"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'area') {
        const checkbox = document.querySelector(`input[data-filter="area"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'areaRange') {
        const areaFrom = document.getElementById('areaFrom');
        const areaTo = document.getElementById('areaTo');
        if (areaFrom) areaFrom.value = '';
        if (areaTo) areaTo.value = '';
    } else if (type === 'direction') {
        const checkbox = document.querySelector(`input[data-filter="direction"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'payment') {
        const checkbox = document.querySelector(`input[data-filter="payment"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'district') {
        const checkbox = document.querySelector(`input[data-filter="district"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'developer') {
        const checkbox = document.querySelector(`input[data-filter="developer"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType') {
        const checkbox = document.querySelector(`input[data-filter="propertyType"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'advancedRooms') {
        const checkbox = document.querySelector(`#advancedFiltersSection input[data-filter="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType2') {
        const checkbox = document.querySelector(`input[data-filter="property_type"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'salesStart') {
        const checkbox = document.querySelector(`input[data-filter="sales_start"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'parking') {
        const checkbox = document.querySelector(`input[data-filter="parking"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'elevator') {
        const checkbox = document.querySelector(`input[data-filter="elevator"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'registration') {
        const checkbox = document.querySelector(`input[data-filter="registration"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'nearbyPlaces') {
        const checkbox = document.querySelector(`input[data-filter="nearby_places"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'windowView') {
        const checkbox = document.querySelector(`input[data-filter="window_view"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'specialApartments') {
        const checkbox = document.querySelector(`input[data-filter="special_apartments"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'worldSides') {
        const checkbox = document.querySelector(`input[data-filter="world_sides"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    }
    
    // Update advanced filters object (excluding duplicates from quick filters)
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.distances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
    advancedFilters.areas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
    advancedFilters.directions = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
    
    // New advanced filters - add to activeFilters too
    advancedFilters.propertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
    advancedFilters.wallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
    advancedFilters.floorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
    advancedFilters.propertyType = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
    advancedFilters.salesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
    advancedFilters.parking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
    advancedFilters.elevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
    advancedFilters.registration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
    advancedFilters.nearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
    advancedFilters.windowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
    advancedFilters.specialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
    advancedFilters.worldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
    
    // Update activeFilters with all new advanced filters
    activeFilters.propertyClass = advancedFilters.propertyClass;
    activeFilters.wallMaterial = advancedFilters.wallMaterial;
    activeFilters.floorsTotal = advancedFilters.floorsTotal;
    activeFilters.propertyType = advancedFilters.propertyType;
    activeFilters.salesStart = advancedFilters.salesStart;
    activeFilters.parking = advancedFilters.parking;
    activeFilters.elevator = advancedFilters.elevator;
    activeFilters.registration = advancedFilters.registration;
    activeFilters.nearbyPlaces = advancedFilters.nearbyPlaces;
    activeFilters.windowView = advancedFilters.windowView;
    activeFilters.specialApartments = advancedFilters.specialApartments;
    activeFilters.worldSides = advancedFilters.worldSides;
    advancedFilters.payments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
    
    // Update area range
    const areaFromValue = document.getElementById('areaFrom')?.value;
    const areaToValue = document.getElementById('areaTo')?.value;
    advancedFilters.areaFrom = parseFloat(areaFromValue) || 0;
    advancedFilters.areaTo = parseFloat(areaToValue) || 0;
    
    filterProperties();
    displayActiveFilters();
}

// View switching functions
function switchToListView() {
    document.getElementById('listViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('gridViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'space-y-6';
        updatePropertiesList(allProperties);
    }
}

function switchToGridView() {
    document.getElementById('gridViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('listViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
        updatePropertiesList(allProperties);
    }
}

function switchToMapView() {
    alert('Карта в разработке');
}

// Clear all active filters
function clearAllActiveFilters() {
    // Clear room filters
    document.querySelectorAll('input[data-filter-type="rooms"]:checked').forEach(cb => cb.checked = false);
    document.getElementById('roomsFilterText').textContent = 'Тип квартиры';
    
    // Clear price filters
    document.getElementById('priceFrom').value = '';
    document.getElementById('priceTo').value = '';
    document.getElementById('priceFilterText').textContent = 'Цена от-до, ₽';
    
    // Clear completion filters
    document.querySelectorAll('input[data-filter-type="completion"]:checked').forEach(cb => cb.checked = false);
    
    // Clear all advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
    
    // Clear area range inputs
    const areaFrom = document.getElementById('areaFrom');
    const areaTo = document.getElementById('areaTo');
    if (areaFrom) areaFrom.value = '';
    if (areaTo) areaTo.value = '';
    
    // Reset advanced filters object
    advancedFilters = {
        districts: [],
        developers: [],
        propertyTypes: [],
        priceMin: 0,
        priceMax: 0,
        roomTypes: [],
        distances: [],
        areas: [],
        directions: [],
        payments: [],
        areaFrom: 0,
        areaTo: 0
    };
    
    // Apply empty filters
    filterProperties();
    displayActiveFilters();
}

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeAdvancedFilters();
    initializeDropdownFilters();
    
    // Initialize NEW filter dropdowns (registration, nearby places, etc.)
    const filterDropdowns = document.querySelectorAll('.filter-dropdown');
    console.log('Found filter dropdowns:', filterDropdowns.length, filterDropdowns);
    filterDropdowns.forEach(dropdown => {
        const btn = dropdown.querySelector('.dropdown-btn');
        const menu = dropdown.querySelector('.dropdown-menu');
        const arrow = dropdown.querySelector('.dropdown-arrow');
        
        if (btn && menu) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close other filter dropdowns
                filterDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                        const otherArrow = otherDropdown.querySelector('.dropdown-arrow');
                        if (otherMenu) otherMenu.classList.add('hidden');
                        if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                    }
                });
                
                // Toggle current dropdown
                const isOpen = !menu.classList.contains('hidden');
                if (isOpen) {
                    menu.classList.add('hidden');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                } else {
                    menu.classList.remove('hidden');
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                }
                
                console.log('Filter dropdown toggled:', dropdown);
                
                // Show dropdown options when opened  
                if (!isOpen) {
                    console.log('Dropdown opened');
                    // Determine filter type from existing checkboxes or button text
                    let filterType = menu.querySelector('input[data-filter]')?.getAttribute('data-filter');
                    
                    if (!filterType) {
                        // If no existing checkboxes, determine from button text
                        const buttonText = btn.textContent.trim();
                        if (buttonText.includes('Прописка')) filterType = 'registration';
                        else if (buttonText.includes('Места рядом')) filterType = 'nearby_places';
                        else if (buttonText.includes('Вид из окон')) filterType = 'window_view';
                        else if (buttonText.includes('Видовые квартиры')) filterType = 'special_apartments';
                        else if (buttonText.includes('Стороны света')) filterType = 'world_sides';
                    }
                    
                    if (filterType) {
                        console.log('Filter type detected:', filterType);
                        showDropdownOptions(menu, filterType);
                    }
                } else {
                    console.log('Dropdown closed');
                }
            });
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-dropdown')) {
            filterDropdowns.forEach(dropdown => {
                const menu = dropdown.querySelector('.dropdown-menu');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                if (menu) menu.classList.add('hidden');
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            });
        }
    });
    
    // Initialize favorite and comparison buttons
    setTimeout(() => {
        initializeAllButtons();
        // Favorites counter now handled by FavoritesManager
        console.log('Initial page setup complete with favorites and comparison');
    }, 100);
    
    // Add click handler for "Все фильтры" button
    const allFiltersButton = document.getElementById('toggleAllFilters');
    if (allFiltersButton) {
        allFiltersButton.addEventListener('click', function() {
            toggleAdvancedFilters();
        });
    }
    
    // Initialize view mode to list by default
    const container = document.getElementById('properties-container');
    if (container && !container.getAttribute('data-view-mode')) {
        container.setAttribute('data-view-mode', 'list');
    }
    
    console.log('Dropdown filters initialized, including', filterDropdowns.length, 'new filter dropdowns');
    
    // Function to show dropdown options for new filters
    function showDropdownOptions(menu, filterType) {
        console.log('Showing options for filter:', filterType);
        const existingOptions = menu.querySelectorAll('input[type="checkbox"]');
        
        // If options already exist, don't duplicate
        if (existingOptions.length > 0) {
            console.log('Options already exist for', filterType);
            return;
        }
        
        let options = [];
        
        // Define options for each filter type
        switch(filterType) {
            case 'registration':
                options = ['Возможна', 'Невозможна', 'Временная'];
                break;
            case 'nearby_places':
                options = ['Школа', 'Детский сад', 'Больница', 'Супермаркет', 'Транспорт', 'Парк'];
                break;
            case 'window_view':
                options = ['На двор', 'На улицу', 'На море', 'На горы'];
                break;
            case 'special_apartments':
                options = ['Угловая', 'Пентхаус', 'Двухуровневая', 'С террасой'];
                break;
            case 'world_sides':
                options = ['Север', 'Юг', 'Восток', 'Запад'];
                break;
            default:
                console.log('Unknown filter type:', filterType);
                return;
        }
        
        // Create container for options if it doesn't exist
        let container = menu.querySelector('.p-3.space-y-2');
        if (!container) {
            container = document.createElement('div');
            container.className = 'p-3 space-y-2';
            menu.appendChild(container);
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        // Add options
        options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer';
            label.innerHTML = `
                <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="${filterType}" value="${option}" onchange="updateAdvancedFilters()"> ${option}
            `;
            container.appendChild(label);
        });
        
        console.log('Added', options.length, 'options for', filterType);
    }
});

// Check if a specific filter has active values
function checkIfFilterIsActive(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Check if any room checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        case 'price':
            // Check if price inputs have values
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            return (priceFrom && priceFrom.value) || (priceTo && priceTo.value);
            
        case 'completion':
            // Check if any completion checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        default:
            // Generic check for any input with value
            const inputs = dropdown.querySelectorAll('input');
            return Array.from(inputs).some(input => {
                if (input.type === 'checkbox') return input.checked;
                if (input.type === 'text' || input.type === 'number') return input.value;
                return false;
            });
    }
}

// Clear specific filter values via double-click (add separate function)
function clearFilterByDoubleClick(button) {
    const dropdown = button.closest('.filter-dropdown') || button.closest('.dropdown');
    if (!dropdown) return;
    
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = 'Тип квартиры';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            button.textContent = 'Цена от-до, ₽';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = 'Срок сдачи';
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
    console.log('Filter cleared by double-click:', filterType);
}

// Clear specific filter values
function clearSpecificFilter(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const roomsBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (roomsBtn) roomsBtn.textContent = 'Тип квартиры';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            // Update button text
            const priceBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (priceBtn) priceBtn.textContent = 'Цена от-до, ₽';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const completionBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (completionBtn) completionBtn.textContent = 'Срок сдачи';
            break;
            
        default:
            // Generic clear for all inputs
            dropdown.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else input.value = '';
            });
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
}

// Legacy function for backward compatibility 
function initializeFavoriteButtons() {
    initializeAllButtons();
}

// handleFavoriteClick function removed - now handled by FavoritesManager

// Initialize comparison and recommendation buttons only
function initializeAllButtons() {
    // Favorites are now handled by FavoritesManager class
    
    // Clear previous initialization for comparison and recommendation buttons
    document.querySelectorAll('.compare-btn').forEach(btn => {
        if (btn.hasAttribute('data-compare-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-compare-initialized');
        }
    });
    document.querySelectorAll('.recommend-btn').forEach(btn => {
        if (btn.hasAttribute('data-recommend-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-recommend-initialized');
        }
    });
    
    // Favorite buttons are now initialized by FavoritesManager
    // Removed duplicate initialization to prevent conflicts
    
    // Initialize comparison buttons with NEW unified system
    document.querySelectorAll('.compare-btn').forEach(btn => {
        const propertyId = parseInt(btn.getAttribute('data-property-id'));
        
        // Update button state using new system
        if (window.ComparisonManager) {
            window.ComparisonManager.updateButton(propertyId);
        }
        
        // Add event listener if not already added
        if (!btn.hasAttribute('data-compare-initialized')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                addToCompare(propertyId);
            });
            btn.setAttribute('data-compare-initialized', 'true');
        }
    });
    
    // Initialize recommendation buttons for managers using the new function
    if (window.manager_authenticated) {
        initializeRecommendButtons();
    }
    
    // Clean up old comparison systems and initialize new one
    localStorage.removeItem('propertyComparison'); // Remove old system
    localStorage.removeItem('complexComparison'); // Remove old system
    
    // Initialize comparison counter on page load
    if (window.ComparisonManager) {
        window.ComparisonManager.updateCounters();
    }
    
    console.log('Initialized buttons for', document.querySelectorAll('.property-card').length, 'properties');
}

// Legacy function for backward compatibility
function initializeComparisonButtons() {
    initializeAllButtons();
}

// Legacy toggleFavorite function - now delegates to FavoritesManager
function toggleFavorite(propertyId) {
    if (window.favoritesManager) {
        const heartElement = document.querySelector(`.favorite-heart[data-property-id="${propertyId}"]`);
        window.favoritesManager.toggleFavorite(propertyId, heartElement);
    } else {
        console.error('FavoritesManager not initialized');
    }
}

// NEW UNIFIED COMPARISON SYSTEM
window.ComparisonManager = {
    // Get current comparison data
    getData: function() {
        return JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
    },
    
    // Save comparison data
    saveData: function(data) {
        localStorage.setItem('comparison-data', JSON.stringify(data));
        this.updateCounters();
    },
    
    // Add property to comparison
    addProperty: function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (!data.properties.includes(idStr)) {
            if (data.properties.length >= 3) {
                this.showMessage('Можно сравнивать максимум 3 квартиры', 'warning');
                return false;
            }
            data.properties.push(idStr);
            this.saveData(data);
            this.showMessage('Квартира добавлена в сравнение', 'success');
            console.log('Property added to comparison:', propertyId);
            return true;
        }
        return false;
    },
    
    // Remove property from comparison
    removeProperty: function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (data.properties.includes(idStr)) {
            data.properties = data.properties.filter(id => id !== idStr);
            this.saveData(data);
            this.showMessage('Квартира удалена из сравнения', 'info');
            console.log('Property removed from comparison:', propertyId);
            return true;
        }
        return false;
    },
    
    // Check if property is in comparison
    hasProperty: function(propertyId) {
        const data = this.getData();
        return data.properties.includes(propertyId.toString());
    },
    
    // Update all counters
    updateCounters: function() {
        const data = this.getData();
        const totalCount = data.properties.length + data.complexes.length;
        
        // Update global comparison counter in header
        const globalCounter = document.getElementById('comparison-count');
        if (globalCounter) {
            globalCounter.textContent = totalCount;
            globalCounter.style.display = totalCount > 0 ? 'flex' : 'none';
        }
        
        // Update dashboard counters if available
        const propertiesCount = document.getElementById('properties-tab-count');
        if (propertiesCount) {
            propertiesCount.textContent = data.properties.length;
        }
        
        const complexesCount = document.getElementById('complexes-tab-count');
        if (complexesCount) {
            complexesCount.textContent = data.complexes.length;
        }
    },
    
    // Show notification message
    showMessage: function(message, type = 'info') {
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            console.log(`[${type}] ${message}`);
        }
    },
    
    // Update button state
    updateButton: function(propertyId) {
        const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
        if (!button) return;
        
        const isInComparison = this.hasProperty(propertyId);
        
        if (isInComparison) {
            button.classList.add('added', 'bg-[#0088CC]', 'text-white');
            button.classList.remove('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-check mr-1"></i><span class="compare-text">В сравнении</span>';
        } else {
            button.classList.remove('added', 'bg-[#0088CC]', 'text-white');
            button.classList.add('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-balance-scale mr-1"></i><span class="compare-text">Сравнить</span>';
        }
    }
};

// Main comparison function
function addToCompare(propertyId) {
    // Prevent rapid clicks
    const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
    if (button && button.disabled) return;
    
    // Temporarily disable button
    if (button) {
        button.disabled = true;
        setTimeout(() => button.disabled = false, 500);
    }
    
    // Toggle comparison state
    if (window.ComparisonManager.hasProperty(propertyId)) {
        window.ComparisonManager.removeProperty(propertyId);
    } else {
        window.ComparisonManager.addProperty(propertyId);
    }
    
    // Update button appearance
    window.ComparisonManager.updateButton(propertyId);
}



// Sort Properties Function
function sortProperties() {
    const sortBy = document.getElementById('sort-select').value;
    currentSortBy = sortBy;
    
    filteredProperties.sort((a, b) => {
        switch(sortBy) {
            case 'price-asc':
                return a.price - b.price;
            case 'price-desc':
                return b.price - a.price;
            case 'area-asc':
                return a.area - b.area;
            case 'area-desc':
                return b.area - a.area;
            case 'date-desc':
                return new Date(b.date_added || '2024-01-01') - new Date(a.date_added || '2024-01-01');
            default:
                return b.price - a.price;
        }
    });
    
    updatePropertiesList(filteredProperties);
    console.log('Properties sorted by:', sortBy);
}

// View Mode Toggle Functions
function switchToListView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - list view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'list');
    
    // Update button styles
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // Re-render properties with list view
    updatePropertiesList(filteredProperties.length > 0 ? filteredProperties : allProperties);
    console.log('Switched to list view');
}

function switchToGridView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - grid view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'grid');
    
    // Update button styles
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // Re-render properties with grid view
    updatePropertiesList(filteredProperties.length > 0 ? filteredProperties : allProperties);
    console.log('Switched to grid view');
}

// Save search dropdown functions
function toggleSaveSearchDropdown() {
    const dropdown = document.getElementById('saveSearchDropdown');
    const isHidden = dropdown.classList.contains('hidden');
    
    if (isHidden) {
        // Close other dropdowns
        document.querySelectorAll('.dropdown-menu.open, .filter-dropdown-menu:not(.hidden)').forEach(menu => {
            menu.classList.add('hidden');
            menu.classList.remove('open');
        });
        
        dropdown.classList.remove('hidden');
        
        // Auto-generate search name
        const searchName = generateSearchName();
        document.getElementById('searchNameInput').value = searchName;
    } else {
        dropdown.classList.add('hidden');
    }
}

function closeSaveSearchDropdown() {
    document.getElementById('saveSearchDropdown').classList.add('hidden');
}

function generateSearchName() {
    const searchData = getCurrentSearchData();
    let searchName = 'Поиск ';
    
    if (searchData.rooms.length > 0) {
        searchName += searchData.rooms.join(', ') + ' ';
    }
    if (searchData.districts.length > 0) {
        searchName += 'в ' + searchData.districts.slice(0, 2).join(', ');
        if (searchData.districts.length > 2) {
            searchName += ` и ещё ${searchData.districts.length - 2}`;
        }
    }
    if (searchData.propertyClass && searchData.propertyClass.length > 0) {
        searchName += `, ${searchData.propertyClass.join(', ')}`;
    }
    if (searchData.wallMaterial && searchData.wallMaterial.length > 0) {
        searchName += `, ${searchData.wallMaterial.join(', ')}`;
    }
    if (searchData.floorsTotal && searchData.floorsTotal.length > 0) {
        searchName += `, ${searchData.floorsTotal.join(', ')}`;
    }
    if (searchData.priceFrom || searchData.priceTo) {
        searchName += `, ${searchData.priceFrom || '0'}-${searchData.priceTo || '∞'} млн`;
    }
    
    return searchName.trim() || `Поиск ${new Date().toLocaleDateString()}`;
}

function getCurrentSearchData() {
    // Get current active filters from the global activeFilters object if available
    if (typeof activeFilters !== 'undefined' && Object.keys(activeFilters).length > 0) {
        const data = {
            districts: activeFilters.districts || [],
            developers: activeFilters.developers || [],
            rooms: activeFilters.rooms || [],
            completion: activeFilters.completion || [],
            propertyClass: activeFilters.propertyClass || [],
            wallMaterial: activeFilters.wallMaterial || [],
            floorsTotal: activeFilters.floorsTotal || [],
            priceFrom: activeFilters.priceFrom || '',
            priceTo: activeFilters.priceTo || '',
            areaFrom: activeFilters.areaFrom || '',
            areaTo: activeFilters.areaTo || ''
        };
        console.log('Using activeFilters for search data:', data);
        return data;
    }
    
    // Collect from quick filters and advanced filters (no duplicates)
    const data = {
        districts: [
            // Only quick filters (removed from advanced to avoid duplication)
            ...Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(el => el.value)
        ],
        developers: [
            // Quick filters (data-filter-type)  
            ...Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(el => el.value),
            // Advanced filters (data-filter)
            ...Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(el => el.value)
        ],
        rooms: [
            // Only quick filters (removed from advanced to avoid duplication)
            ...Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(el => el.value)
        ],
        completion: [
            // Quick filters (data-filter-type)
            ...Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(el => el.value)
        ],
        // New advanced-only filters
        propertyClass: Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(el => el.value),
        wallMaterial: Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(el => el.value),
        floorsTotal: Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(el => el.value),
        priceFrom: document.getElementById('priceFrom')?.value || '',
        priceTo: document.getElementById('priceTo')?.value || '',
        areaFrom: document.getElementById('areaFrom')?.value || '',
        areaTo: document.getElementById('areaTo')?.value || ''
    };
    console.log('Using DOM queries for search data:', data);
    return data;
}

// Enhanced save search function
async function saveSearchWithOptions() {
    const userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
    const managerId = {{ session.get('manager_id', 'null') }};
    const userRole = '{{ current_user.role if current_user.is_authenticated else "" }}';
    const managerRole = {{ 'true' if session.get('is_manager') else 'false' }};
    
    if (!userId && !managerId) {
        alert('Для сохранения поиска необходимо войти в систему');
        return;
    }
    
    const searchName = document.getElementById('searchNameInput').value.trim();
    const clientEmail = document.getElementById('clientEmailInput')?.value.trim() || '';
    
    if (!searchName) {
        alert('Введите название поиска');
        return;
    }
    
    const searchData = getCurrentSearchData();
    
    // Check if any filters are selected (including new advanced filters)
    const hasFilters = searchData.districts.length > 0 || 
                      searchData.developers.length > 0 || 
                      searchData.rooms.length > 0 || 
                      searchData.completion.length > 0 ||
                      (searchData.propertyClass && searchData.propertyClass.length > 0) ||
                      (searchData.wallMaterial && searchData.wallMaterial.length > 0) ||
                      (searchData.floorsTotal && searchData.floorsTotal.length > 0) ||
                      searchData.priceFrom || searchData.priceTo ||
                      searchData.areaFrom || searchData.areaTo;
    
    if (!hasFilters) {
        alert('Выберите хотя бы один фильтр для сохранения поиска');
        return;
    }
    
    try {
        console.log('Saving search with data:', searchData);
        
        const requestData = {
            name: searchName,
            filters: searchData
        };
        
        // Add client email for managers
        if (managerRole && clientEmail) {
            requestData.client_email = clientEmail;
        }
        
        console.log('Request data:', requestData);
        
        // Choose endpoint based on user type
        const endpoint = managerRole ? '/api/manager/saved-searches' : '/api/searches';
        
        console.log('Manager detection debug:', {
            managerRole: managerRole,
            managerId: managerId, 
            endpoint: endpoint
        });
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            closeSaveSearchDropdown();
            
            if (clientEmail && managerRole) {
                alert(`Поиск успешно сохранён и отправлен клиенту на ${clientEmail}!`);
            } else {
                alert('Поиск успешно сохранён!');
            }
        } else {
            const error = await response.json();
            alert('Ошибка при сохранении поиска: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('Ошибка при сохранении поиска. Попробуйте позже.');
    }
}

// Legacy function for backward compatibility
async function saveCurrentSearch() {
    toggleSaveSearchDropdown();
    
    // Use the unified getCurrentSearchData function
    const searchData = getCurrentSearchData();
    
    // Check if any filters are selected (including new advanced filters)  
    const hasFilters = searchData.districts.length > 0 || 
                      searchData.developers.length > 0 || 
                      searchData.rooms.length > 0 || 
                      searchData.completion.length > 0 ||
                      (searchData.propertyClass && searchData.propertyClass.length > 0) ||
                      (searchData.wallMaterial && searchData.wallMaterial.length > 0) ||
                      (searchData.floorsTotal && searchData.floorsTotal.length > 0) ||
                      searchData.priceFrom || searchData.priceTo ||
                      searchData.areaFrom || searchData.areaTo;
    
    if (!hasFilters) {
        alert('Выберите хотя бы один фильтр для сохранения поиска');
        return;
    }
    
    // Generate search name using the unified function
    const searchName = generateSearchName();
    
    try {
        const response = await fetch('/api/searches', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: searchName.trim(),
                filters: searchData
            })
        });
        
        if (response.ok) {
            alert('Поиск успешно сохранён!');
        } else {
            const error = await response.json();
            alert('Ошибка при сохранении поиска: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('Ошибка при сохранении поиска. Попробуйте позже.');
    }
}

// Legacy function compatibility
function updateComparisonCounter() {
    if (window.ComparisonManager) {
        window.ComparisonManager.updateCounters();
    }
}

// Legacy function compatibility
window.removeFromComparison = function(propertyId) {
    if (window.ComparisonManager) {
        window.ComparisonManager.removeProperty(propertyId);
        window.ComparisonManager.updateButton(propertyId);
    }
}

// Update active filters display
function updateActiveFiltersDisplay(filters) {
    const filtersToShow = filters || activeFilters;
    console.log('Updating active filters display:', filtersToShow);
    
    // Get URL parameters for price display
    const urlParams = new URLSearchParams(window.location.search);
    const priceMin = urlParams.get('price_min');
    const priceMax = urlParams.get('price_max');
    const district = urlParams.get('district');
    
    // Update active filters with URL parameters if available
    if (priceMin || priceMax) {
        filtersToShow.priceFrom = priceMin ? (parseInt(priceMin) / 1000000) : 0;
        filtersToShow.priceTo = priceMax ? (parseInt(priceMax) / 1000000) : 0;
    }
    
    if (district && !filtersToShow.districts.includes(district)) {
        filtersToShow.districts = [district];
    }
    
    console.log('Updated filters with URL params:', filtersToShow);
}

// Apply URL filters function for saved searches
function applyFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.toString() === '') return; // No URL parameters
    
    console.log('Applying filters from URL:', urlParams.toString());
    
    // Reset all filters first
    activeFilters = {
        rooms: [],
        districts: [],
        developers: [],
        completion: [],
        propertyClass: [],
        wallMaterial: [],
        floorsTotal: [],
        priceFrom: 0,
        priceTo: 0
    };
    
    // Clear all checkboxes and inputs
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => input.value = '');
    
    // Check for simple array parameters first (rooms[], districts[], etc.)
    urlParams.forEach((value, key) => {
        if (key.endsWith('[]')) {
            const filterKey = key.slice(0, -2);
            if (!activeFilters[filterKey]) {
                activeFilters[filterKey] = [];
            }
            activeFilters[filterKey].push(value);
            
            // Check corresponding checkbox
            const checkbox = document.querySelector(`input[data-filter-type="${filterKey}"][value="${value}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        } else if (['rooms', 'districts', 'developers', 'completion'].includes(key)) {
            // Handle single values for filter types (from saved searches)
            if (!activeFilters[key]) {
                activeFilters[key] = [];
            }
            // Split multiple values by comma if they exist
            const values = value.split(',').map(v => v.trim()).filter(v => v);
            activeFilters[key] = activeFilters[key].concat(values);
            
            // Check corresponding checkboxes
            values.forEach(val => {
                const checkbox = document.querySelector(`input[data-filter-type="${key}"][value="${val}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    console.log(`Checked ${key} checkbox for value: ${val}`);
                }
            });
        } else if (['priceFrom', 'priceTo', 'areaFrom', 'areaTo'].includes(key)) {
            activeFilters[key] = parseFloat(value) || 0;
            const input = document.getElementById(key);
            if (input) {
                input.value = value;
            }
        } else if (key === 'price_min' || key === 'price_max') {
            // Handle price parameters from saved searches
            const priceInMillions = parseFloat(value) / 1000000;
            if (key === 'price_min') {
                activeFilters.priceFrom = priceInMillions;
                const input = document.getElementById('priceFrom');
                if (input) input.value = priceInMillions;
            } else {
                activeFilters.priceTo = priceInMillions;
                const input = document.getElementById('priceTo');
                if (input) input.value = priceInMillions;
            }
        } else if (key === 'district') {
            // Handle single district parameter
            if (!activeFilters.districts.includes(value)) {
                activeFilters.districts.push(value);
            }
            const checkbox = document.querySelector(`input[data-filter-type="districts"][value="${value}"]`);
            if (checkbox) {
                checkbox.checked = true;
                console.log(`Checked district checkbox for value: ${value}`);
            }
        }
    });
    
    // Check for complex additional_filters parameter (from dashboard)
    const additionalFilters = urlParams.get('additional_filters');
    if (additionalFilters) {
        try {
            const parsedFilters = JSON.parse(decodeURIComponent(additionalFilters));
            console.log('Parsed additional filters:', parsedFilters);
            
            // Apply rooms filter - check BOTH quick and advanced filters
            if (parsedFilters.rooms && parsedFilters.rooms.length > 0) {
                activeFilters.rooms = parsedFilters.rooms;
                parsedFilters.rooms.forEach(room => {
                    // Check quick filters (data-filter-type)
                    const quickCheckbox = document.querySelector(`input[data-filter-type="rooms"][value="${room}"]`);
                    if (quickCheckbox) {
                        quickCheckbox.checked = true;
                        console.log(`Checked quick rooms checkbox for value: ${room}`);
                    }
                    
                    // Check advanced filters (data-filter)
                    const advancedCheckbox = document.querySelector(`input[data-filter="rooms"][value="${room}"]`);
                    if (advancedCheckbox) {
                        advancedCheckbox.checked = true;
                        console.log(`Checked advanced rooms checkbox for value: ${room}`);
                    }
                });
            }
            
            // Apply other array filters - check BOTH quick and advanced filters
            ['districts', 'developers', 'completion', 'propertyClass', 'wallMaterial', 'floorsTotal'].forEach(filterType => {
                if (parsedFilters[filterType] && parsedFilters[filterType].length > 0) {
                    activeFilters[filterType] = parsedFilters[filterType];
                    parsedFilters[filterType].forEach(value => {
                        // For districts and rooms - only check quick filters (no duplication)
                        if (filterType === 'districts') {
                            const quickCheckbox = document.querySelector(`input[data-filter-type="district"][value="${value}"]`);
                            if (quickCheckbox) {
                                quickCheckbox.checked = true;
                                console.log(`Checked quick district checkbox for value: ${value}`);
                            }
                        }
                        // For developers - check both quick and advanced
                        else if (filterType === 'developers') {
                            const quickCheckbox = document.querySelector(`input[data-filter-type="developer"][value="${value}"]`);
                            if (quickCheckbox) {
                                quickCheckbox.checked = true;
                                console.log(`Checked quick developer checkbox for value: ${value}`);
                            }
                            const advancedCheckbox = document.querySelector(`input[data-filter="developer"][value="${value}"]`);
                            if (advancedCheckbox) {
                                advancedCheckbox.checked = true;
                                console.log(`Checked advanced developer checkbox for value: ${value}`);
                            }
                        }
                        // For completion - only quick filters
                        else if (filterType === 'completion') {
                            const quickCheckbox = document.querySelector(`input[data-filter-type="completion"][value="${value}"]`);
                            if (quickCheckbox) {
                                quickCheckbox.checked = true;
                                console.log(`Checked quick completion checkbox for value: ${value}`);
                            }
                        }
                        // For new advanced-only filters
                        else if (['propertyClass', 'wallMaterial', 'floorsTotal'].includes(filterType)) {
                            const filterName = filterType.replace(/([A-Z])/g, '_$1').toLowerCase();
                            const advancedCheckbox = document.querySelector(`input[data-filter="${filterName}"][value="${value}"]`);
                            if (advancedCheckbox) {
                                advancedCheckbox.checked = true;
                                console.log(`Checked advanced ${filterName} checkbox for value: ${value}`);
                            }
                        }
                    });
                }
            });
            
            // Apply price and area filters
            if (parsedFilters.priceFrom) {
                activeFilters.priceFrom = parseFloat(parsedFilters.priceFrom) || 0;
                const input = document.getElementById('priceFrom');
                if (input) input.value = parsedFilters.priceFrom;
            }
            if (parsedFilters.priceTo) {
                activeFilters.priceTo = parseFloat(parsedFilters.priceTo) || 0;
                const input = document.getElementById('priceTo');
                if (input) input.value = parsedFilters.priceTo;
            }
            if (parsedFilters.areaFrom) {
                activeFilters.areaFrom = parseFloat(parsedFilters.areaFrom) || 0;
                const input = document.getElementById('areaFrom');
                if (input) input.value = parsedFilters.areaFrom;
            }
            if (parsedFilters.areaTo) {
                activeFilters.areaTo = parseFloat(parsedFilters.areaTo) || 0;
                const input = document.getElementById('areaTo');
                if (input) input.value = parsedFilters.areaTo;
            }
        } catch (error) {
            console.error('Error parsing additional_filters:', error);
        }
    }
    
    // Apply filters to properties
    if (Object.keys(activeFilters).some(key => 
        Array.isArray(activeFilters[key]) ? activeFilters[key].length > 0 : activeFilters[key] > 0
    )) {
        console.log('Applied URL filters:', activeFilters);
        filterProperties();
        updateActiveFiltersDisplay();
    }
}

// Initialize URL filter application on page load
document.addEventListener('DOMContentLoaded', function() {
    // Wait for data to load, then apply URL filters
    setTimeout(() => {
        applyFiltersFromURL();
    }, 1000);
});

// Recommendation system for managers
function initializeRecommendButtons() {
    console.log('Initializing recommend buttons...');
    
    // Remove existing listeners and add new ones directly to buttons
    document.querySelectorAll('.recommend-btn').forEach(btn => {
        if (btn.hasAttribute('data-listener-added')) return;
        
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const propertyId = this.dataset.propertyId;
            const propertyName = this.dataset.propertyName;
            const complexName = this.dataset.complexName;
            
            console.log('Recommend button clicked:', {propertyId, propertyName, complexName});
            
            if (!propertyId) {
                console.error('Property ID is missing');
                alert('Ошибка: отсутствует ID объекта');
                return;
            }
            
            // Create property data object
            const property = {
                id: propertyId,
                name: propertyName || `Объект ${propertyId}`,
                complex_name: complexName || '',
                rooms: 'н/д'
            };
            
            console.log('Using property data:', property);
            openRecommendModal('property', propertyId, property);
        });
        
        btn.setAttribute('data-listener-added', 'true');
    });
    
    console.log('Recommend buttons initialized:', document.querySelectorAll('.recommend-btn').length);
}

function openRecommendModal(type, itemId, itemData) {
    const modal = document.getElementById('recommendModal') || createRecommendModal();
    
    console.log('Opening recommend modal with:', {type, itemId, itemData});
    
    // Determine item name based on type
    let itemName = '';
    if (type === 'property') {
        itemName = itemData.name || itemData.title || `Квартира ${itemData.rooms}к` || 'Недвижимость';
    } else if (type === 'complex') {
        itemName = itemData.name || itemData.title || 'ЖК';
    }
    
    // Fill modal with data
    const typeField = document.getElementById('recommendType');
    const idField = document.getElementById('recommendItemId');
    const nameField = document.getElementById('recommendItemName');
    const titleField = document.getElementById('recommendTitle');
    
    if (!typeField || !idField || !nameField || !titleField) {
        console.error('Modal fields not found');
        return;
    }
    
    typeField.value = type;
    idField.value = String(itemId);
    nameField.value = itemName;
    titleField.value = `Рекомендую: ${itemName}`;
    
    console.log('Modal fields set:', {
        type: typeField.value,
        itemId: idField.value,
        itemName: nameField.value,
        title: titleField.value
    });
    
    // Load clients if not already loaded
    loadClientsForRecommendation();
    
    // Show modal
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function createRecommendModal() {
    const modal = document.createElement('div');
    modal.id = 'recommendModal';
    modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Отправить рекомендацию клиенту</h3>
                <button onclick="closeRecommendModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="recommendForm" class="space-y-4">
                <input type="hidden" id="recommendType">
                <input type="hidden" id="recommendItemId">
                <input type="hidden" id="recommendItemName">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Заголовок рекомендации</label>
                    <input type="text" id="recommendTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Клиент *</label>
                    <select id="recommendClientSelect" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                        <option value="">Выберите клиента...</option>
                    </select>
                    <input type="hidden" id="recommendClientEmail">
                </div>
                
                <div id="categorySection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Категория рекомендации</label>
                    <div class="space-y-2">
                        <select id="recommendCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                            <option value="">Без категории</option>
                            <option value="new">+ Создать новую категорию</option>
                        </select>
                        <div id="newCategoryInput" class="hidden">
                            <input type="text" id="recommendCategoryName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]" placeholder="Например: Однокомнатные до 5 млн, Черемушки">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Описание (опционально)</label>
                    <textarea id="recommendDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]" placeholder="Краткое описание для клиента"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ваши заметки</label>
                    <textarea id="recommendNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]" placeholder="Почему рекомендуете этот объект"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Приоритет</label>
                    <select id="recommendPriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                        <option value="normal">Обычный</option>
                        <option value="high">Высокий</option>
                        <option value="urgent">Срочный</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" id="submitRecommendBtn" class="flex-1 px-4 py-2 bg-[#0088CC] text-white rounded-md hover:bg-[#0077BB] transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-2" id="submitIcon"></i>
                        <span class="loading-spinner hidden mr-2">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        <span id="submitText">Отправить рекомендацию</span>
                    </button>
                    <button type="button" onclick="closeRecommendModal()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                        Отмена
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add form submit handler
    document.getElementById('recommendForm').addEventListener('submit', handleRecommendSubmit);
    
    // Load clients list
    loadClientsForRecommendation();
    
    return modal;
}

// Load clients for recommendation dropdown
async function loadClientsForRecommendation() {
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        const select = document.getElementById('recommendClientSelect');
        select.innerHTML = '<option value="">Выберите клиента...</option>';
        
        if (data.success && data.clients) {
            data.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.full_name} (${client.email})`;
                option.dataset.email = client.email;
                select.appendChild(option);
            });
            
            // Add change handler
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const emailInput = document.getElementById('recommendClientEmail');
                const categorySection = document.getElementById('categorySection');
                
                if (selectedOption.dataset.email) {
                    emailInput.value = selectedOption.dataset.email;
                    categorySection.classList.remove('hidden');
                    loadRecommendationCategories(this.value);
                } else {
                    emailInput.value = '';
                    categorySection.classList.add('hidden');
                }
            });
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

// Load recommendation categories for selected client
async function loadRecommendationCategories(clientId) {
    try {
        const response = await fetch(`/api/manager/recommendation-categories/${clientId}`);
        const data = await response.json();
        
        const select = document.getElementById('recommendCategorySelect');
        select.innerHTML = '<option value="">Без категории</option><option value="new">+ Создать новую категорию</option>';
        
        if (data.success && data.categories) {
            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.recommendations_count})`;
                select.appendChild(option);
            });
        }
        
        // Add change handler for category selection
        select.addEventListener('change', function() {
            const newCategoryInput = document.getElementById('newCategoryInput');
            if (this.value === 'new') {
                newCategoryInput.classList.remove('hidden');
            } else {
                newCategoryInput.classList.add('hidden');
            }
        });
        
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function closeRecommendModal() {
    const modal = document.getElementById('recommendModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('recommendForm').reset();
        
        // Reset button state
        const submitBtn = document.getElementById('submitRecommendBtn');
        const submitIcon = document.getElementById('submitIcon');
        const submitText = document.getElementById('submitText');
        const spinner = submitBtn.querySelector('.loading-spinner');
        
        if (submitBtn && submitIcon && submitText && spinner) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-green-500');
            submitBtn.classList.add('bg-[#0088CC]', 'hover:bg-[#0077BB]');
            spinner.classList.add('hidden');
            submitIcon.classList.remove('hidden');
            submitIcon.className = 'fas fa-paper-plane mr-2';
            submitText.textContent = 'Отправить рекомендацию';
        }
    }
}

function showRecommendationLoading() {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    if (submitBtn && submitIcon && submitText && spinner) {
        submitBtn.disabled = true;
        submitIcon.classList.add('hidden');
        spinner.classList.remove('hidden');
        submitText.textContent = 'Отправка...';
    }
}

function showRecommendationSuccess() {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    if (submitBtn && submitIcon && submitText && spinner) {
        spinner.classList.add('hidden');
        submitIcon.classList.remove('hidden');
        submitIcon.className = 'fas fa-check mr-2';
        submitText.textContent = 'Отправлено!';
        submitBtn.classList.remove('bg-[#0088CC]', 'hover:bg-[#0077BB]');
        submitBtn.classList.add('bg-green-500');
    }
}

function showRecommendationError(message) {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    if (submitBtn && submitIcon && submitText && spinner) {
        submitBtn.disabled = false;
        spinner.classList.add('hidden');
        submitIcon.classList.remove('hidden');
        submitIcon.className = 'fas fa-paper-plane mr-2';
        submitText.textContent = 'Отправить рекомендацию';
    }
    
    alert(message);
}

async function handleRecommendSubmit(e) {
    e.preventDefault();
    
    const clientSelect = document.getElementById('recommendClientSelect');
    const selectedClientId = clientSelect.value;
    
    if (!selectedClientId) {
        alert('Выберите клиента для отправки рекомендации');
        return;
    }
    
    const categorySelect = document.getElementById('recommendCategorySelect');
    const categoryValue = categorySelect ? categorySelect.value : '';
    const categoryName = categoryValue === 'new' ? document.getElementById('recommendCategoryName').value.trim() : '';
    
    const formData = {
        recommendation_type: document.getElementById('recommendType').value,
        item_id: document.getElementById('recommendItemId').value,
        item_name: document.getElementById('recommendItemName').value,
        title: document.getElementById('recommendTitle').value.trim(),
        client_id: selectedClientId,
        client_email: document.getElementById('recommendClientEmail').value.trim(),
        description: document.getElementById('recommendDescription').value.trim(),
        manager_notes: document.getElementById('recommendNotes').value.trim(),
        priority_level: document.getElementById('recommendPriority').value,
        category_id: categoryValue,
        category_name: categoryName,
        highlighted_features: [], // Can be expanded later
        item_data: {} // Can include full property data
    };
    
    if (!formData.title) {
        alert('Введите заголовок рекомендации');
        return;
    }
    
    // Show loading state
    showRecommendationLoading();
    
    try {
        // Debug log the form data being sent
        console.log('Sending recommendation with data:', formData);
        
        const response = await fetch('/api/manager/send_recommendation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showRecommendationSuccess();
            
            setTimeout(() => {
                closeRecommendModal();
                if (result.sent_to_client) {
                    alert(`Рекомендация успешно отправлена клиенту на ${formData.client_email}!`);
                } else {
                    alert('Рекомендация сохранена, но email не был отправлен. Проверьте настройки уведомлений.');
                }
            }, 1500);
        } else {
            const error = await response.json();
            showRecommendationError('Ошибка при отправке рекомендации: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error sending recommendation:', error);
        showRecommendationError('Ошибка при отправке рекомендации. Попробуйте позже.');
    }
}

// Initialize recommendation buttons when manager authenticated
if (window.manager_authenticated) {
    console.log('Manager authenticated, recommendation buttons will be initialized');
    // Initialize buttons on page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            initializeRecommendButtons();
        }, 1000);
    });
}

// Smart Search Integration
function initializeSmartSearch() {
    console.log('Initializing smart search integration...');
    
    // Test smart search API on page load
    testSmartSearchAPI();
}

function testSmartSearchAPI() {
    console.log('Testing smart search API...');
    
    fetch('/api/smart-search?q=квартира')
        .then(response => response.json())
        .then(data => {
            console.log('Smart search API test successful:', data);
            showSmartSearchStatus(true, data);
        })
        .catch(error => {
            console.error('Smart search API test failed:', error);
            showSmartSearchStatus(false);
        });
}

function showSmartSearchStatus(isWorking, data = null) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${isWorking ? 'bg-green-500' : 'bg-red-500'} text-white`;
    
    let detailText = isWorking ? 'OpenAI интеграция работает' : 'Используется обычный поиск';
    if (data && data.criteria) {
        const criteriaCount = Object.keys(data.criteria).length;
        detailText = `Найдено ${criteriaCount} критериев поиска`;
    }
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${isWorking ? 'fa-brain' : 'fa-exclamation-triangle'} mr-2"></i>
            <div>
                <div class="font-semibold">${isWorking ? 'Умный поиск активирован!' : 'Умный поиск недоступен'}</div>
                <div class="text-sm">${detailText}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Initialize smart search on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initializeSmartSearch();
    }, 2000); // Wait 2 seconds after page load
});

// Ensure proper script closure
console.log('Properties page script loaded with smart search integration');

// PDF Download Function
function downloadPropertyPDF(propertyId) {
    // Create and trigger download
    const downloadLink = document.createElement('a');
    downloadLink.href = `/api/property/${propertyId}/pdf`;
    downloadLink.download = `property-${propertyId}.html`;
    downloadLink.target = '_blank';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    
    console.log(`PDF download initiated for property ${propertyId}`);
}

// Show notification function (same style as favorites)
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    
    // Style based on type
    if (type === 'success') {
        notification.classList.add('bg-green-500', 'text-white');
        notification.innerHTML = `<i class="fas fa-balance-scale mr-2"></i>${message}`;
    } else if (type === 'warning') {
        notification.classList.add('bg-yellow-500', 'text-white');
        notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
    } else {
        notification.classList.add('bg-blue-500', 'text-white');
        notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
    }
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Animate out and remove
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Comparison toggle function with authentication check
function toggleComparison(propertyId, buttonElement) {
    // Check if user is authenticated (same logic as favorites)
    const isAuthenticated = document.querySelector('a[href*="dashboard"]') !== null;
    
    if (!isAuthenticated) {
        // Show styled notification and redirect to login (same as favorites)
        showNotification('Для добавления в сравнение необходимо зарегистрироваться или войти в систему', 'warning');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1500);
        return;
    }
    
    try {
        const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
        const isInComparison = comparisonData.properties.includes(propertyId);
        
        if (isInComparison) {
            // Remove from comparison
            comparisonData.properties = comparisonData.properties.filter(id => id !== propertyId);
            buttonElement.style.background = '#ffffff';
            buttonElement.querySelector('i').style.color = '#6b7280';
            buttonElement.classList.remove('active');
        } else {
            // Add to comparison
            comparisonData.properties.push(propertyId);
            buttonElement.style.background = '#0088CC';
            buttonElement.querySelector('i').style.color = 'white';
            buttonElement.classList.add('active');
        }
        
        localStorage.setItem('comparison-data', JSON.stringify(comparisonData));
        console.log('Comparison updated:', comparisonData.properties.length, 'properties');
        
        // Update comparison counter if exists
        const counter = document.querySelector('.comparison-counter');
        if (counter) {
            counter.textContent = comparisonData.properties.length;
            counter.style.display = comparisonData.properties.length > 0 ? 'inline-flex' : 'none';
        }
    } catch (error) {
        console.error('Error toggling comparison:', error);
    }
}

// Update button initialization to include new buttons
function initializeAllButtons() {
    // Initialize favorites
    if (window.favoritesManager) {
        const heartElements = document.querySelectorAll('.favorite-heart');
        heartElements.forEach(heart => {
            if (window.favoritesManager.toggleFavorite) {
                // Already initialized
                return;
            }
        });
    }
    
    // Initialize comparison buttons
    const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
    document.querySelectorAll('.comparison-btn').forEach(btn => {
        const propertyId = btn.dataset.propertyId;
        
        if (comparisonData.properties.includes(propertyId)) {
            btn.style.background = '#0088CC';
            btn.querySelector('i').style.color = 'white';
            btn.classList.add('active');
        } else {
            btn.style.background = '#ffffff';
            btn.querySelector('i').style.color = '#6b7280';
            btn.classList.remove('active');
        }
    });
    
    console.log('All buttons initialized: favorites, comparison, PDF');
}

// Debug favorites system
setTimeout(() => {
    console.log('=== FAVORITES DEBUG START ===');
    console.log('favoritesManager instance:', typeof window.favoritesManager);
    console.log('Heart elements:', document.querySelectorAll('.favorite-heart').length);
    console.log('User authenticated check:', document.querySelector('a[href*="dashboard"]') !== null);
    console.log('=== FAVORITES DEBUG END ===');
}, 3000);

</script>

<!-- Favorites system is loaded globally in base.html to prevent duplicates -->

{% endblock %}
